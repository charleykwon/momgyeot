<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üíö ÎßòÍ≥Å - ÏóÑÎßà ÎßàÏùå Í≥ÅÏóê</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --olive: #5E6B3A;
            --olive-light: #7A8B52;
            --olive-dark: #4A5530;
            --pink: #E8B4B8;
            --pink-light: #F5D5D8;
            --purple: #9B8AA6;
            --purple-light: #C4B8CE;
            --cream: #FDF8F5;
            --cream-dark: #F0EBE6;
            --text-dark: #2D2D2D;
            --text-medium: #5A5A5A;
            --text-light: #8A8A8A;
            --white: #FFFFFF;
            --card-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            --card-shadow-hover: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #F5F5F5;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            background: var(--white);
            position: relative;
            overflow-x: hidden;
        }

        .screen {
            display: none;
            flex-direction: column;
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ==================== HOME SCREEN ==================== */
        .home-screen {
            background: linear-gradient(180deg, 
                #E8F0E3 0%, 
                #F5E6E8 30%,
                #EDE8F0 60%,
                #FFFFFF 100%
            );
        }

        .home-header {
            padding: 16px 20px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .home-header-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 12px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .home-header-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        /* Side Menu */
        .side-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .side-menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .side-menu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100%;
            background: var(--white);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: -4px 0 20px rgba(0,0,0,0.1);
        }

        .side-menu.active {
            right: 0;
        }

        .side-menu-header {
            padding: 18px 16px;
            background: linear-gradient(135deg, var(--mothers-olive), var(--mothers-olive-light));
            color: white;
        }

        .side-menu-header h2 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .side-menu-header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .side-menu-close {
            position: absolute;
            top: 20px;
            right: 16px;
            background: rgba(255,255,255,0.2);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .side-menu-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px 0;
        }

        .side-menu-section {
            padding: 6px 16px;
        }

        .side-menu-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            padding-left: 4px;
        }

        .side-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            margin-bottom: 6px;
            background: var(--bg-light);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: var(--text-dark);
        }

        .side-menu-item:hover {
            background: var(--mothers-olive-light);
            transform: translateX(4px);
        }

        .side-menu-item .item-icon {
            width: 32px;
            height: 32px;
            background: var(--white);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            flex-shrink: 0;
        }

        .side-menu-item .item-info {
            flex: 1;
            min-width: 0;
        }

        .side-menu-item .item-name {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .side-menu-item .item-desc {
            display: none;
        }

        .side-menu-item .item-arrow {
            color: var(--text-light);
            font-size: 12px;
            flex-shrink: 0;
        }

        .side-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 10px 16px;
        }

        .home-greeting {
            padding: 20px 24px 32px;
            text-align: center;
        }

        .home-title {
            font-size: 26px;
            font-weight: 600;
            color: var(--text-dark);
            line-height: 1.4;
        }

        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 0 24px 32px;
            align-items: center;
        }

        .quick-action-btn {
            background: var(--white);
            border: none;
            padding: 14px 24px;
            border-radius: 50px;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--card-shadow);
            transition: all 0.2s;
            font-family: inherit;
        }

        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-hover);
        }

        /* Ïò®Î≥¥Îî© ÏôÑÎ£å ÌõÑ Í∞ÄÎ°úÌòï Quick Actions */
        .quick-actions-mini {
            display: flex;
            gap: 10px;
            padding: 0 20px 24px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .quick-actions-mini::-webkit-scrollbar {
            display: none;
        }

        .quick-action-mini-btn {
            background: var(--white);
            border: 1.5px solid var(--mothers-olive-light);
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--card-shadow);
            transition: all 0.2s;
            font-family: inherit;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .quick-action-mini-btn .icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .quick-action-mini-btn .icon.green {
            background: linear-gradient(135deg, #5E6B3A, #7A8A4A);
            color: white;
        }

        .quick-action-mini-btn .icon.pink {
            background: linear-gradient(135deg, #E8B4B8, #D9A5A9);
            color: white;
        }

        .quick-action-mini-btn .icon.olive {
            background: linear-gradient(135deg, #8B9A5C, #A8B878);
            color: white;
        }

        .quick-action-mini-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-hover);
            border-color: var(--mothers-olive);
        }

        .quick-action-mini-btn:active {
            transform: scale(0.98);
        }

        /* Î©îÏù∏ ÎßòÍ≥Å Ïπ¥Îìú (ÌÅ¨Í≤å) */
        .main-mate-card {
            background: var(--white);
            border-radius: 24px;
            padding: 24px;
            margin: 0 20px 20px;
            box-shadow: var(--card-shadow);
            cursor: pointer;
            transition: all 0.2s;
        }

        .main-mate-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-hover);
        }

        .main-mate-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .main-mate-avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            flex-shrink: 0;
        }

        .main-mate-avatar.olive { background: linear-gradient(135deg, #E8F0E3 0%, #D4E4CC 100%); }
        .main-mate-avatar.purple { background: linear-gradient(135deg, #EDE8F0 0%, #DDD4E4 100%); }
        .main-mate-avatar.pink { background: linear-gradient(135deg, #F5E6E8 0%, #EEDAD8 100%); }

        .main-mate-info { flex: 1; }

        .main-mate-greeting {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .main-mate-name {
            font-size: 14px;
            color: var(--text-light);
        }

        .main-mate-message {
            font-size: 15px;
            color: var(--text-dark);
            line-height: 1.6;
            background: var(--bg-light);
            padding: 14px 16px;
            border-radius: 16px;
        }

        .main-mate-action {
            display: flex;
            justify-content: flex-end;
            margin-top: 16px;
        }

        .main-mate-btn {
            background: var(--olive);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .main-mate-btn:hover {
            background: var(--olive-dark);
        }

        /* ==================== ÎåÄÌôî ÌûàÏä§ÌÜ†Î¶¨ ÏÑπÏÖò ==================== */
        .chat-history-section {
            margin: 0 20px 24px;
        }
        
        .chat-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .chat-history-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .chat-history-count {
            font-size: 13px;
            color: var(--text-light);
            background: var(--bg-light);
            padding: 4px 10px;
            border-radius: 12px;
        }
        
        .date-group {
            margin-bottom: 16px;
        }
        
        .date-group-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            margin-bottom: 8px;
        }
        
        .date-group-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--olive);
        }
        
        .date-group-count {
            font-size: 12px;
            color: var(--text-light);
            background: var(--bg-light);
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .date-group-line {
            flex: 1;
            height: 1px;
            background: var(--border-light);
        }
        
        .history-item {
            background: var(--white);
            border-radius: 16px;
            padding: 14px 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .history-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .history-item-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
        }
        
        .history-item-content {
            flex: 1;
            min-width: 0;
        }
        
        .history-item-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 2px;
        }
        
        .history-item-preview {
            font-size: 13px;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .history-item-time {
            font-size: 12px;
            color: var(--text-light);
            flex-shrink: 0;
        }
        
        .history-item-arrow {
            color: var(--text-light);
            font-size: 16px;
        }
        
        .view-all-btn {
            width: 100%;
            padding: 14px;
            background: var(--bg-light);
            border: 1px dashed var(--border-light);
            border-radius: 16px;
            color: var(--text-light);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: inherit;
        }
        
        .view-all-btn:hover {
            background: var(--white);
            border-color: var(--olive);
            color: var(--olive);
        }
        
        .no-history-message {
            text-align: center;
            padding: 32px 20px;
            color: var(--text-light);
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* Ï†ÑÏ≤¥ ÎåÄÌôî Î™®Îã¨ */
        .history-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-light);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .history-modal.active {
            display: block;
        }
        
        .history-modal-header {
            position: sticky;
            top: 0;
            background: var(--white);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border-light);
            z-index: 10;
        }
        
        .history-modal-back {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--bg-light);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .history-modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .history-modal-content {
            padding: 20px;
        }

        /* Ïò§ÎäòÏùò ÌïúÎßàÎîî Ïπ¥Îìú */
        .tip-card {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFF5D6 100%);
            border-radius: 20px;
            padding: 20px;
            margin: 0 20px 24px;
        }

        .tip-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .tip-card-label {
            font-size: 12px;
            font-weight: 600;
            color: #B8860B;
        }

        .tip-card-content {
            font-size: 15px;
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* Í∞úÏù∏Ìôî Ïù∏ÏÇ¨ */
        .personalized-greeting {
            padding: 32px 24px 24px;
            text-align: center;
        }

        .personalized-greeting h1 {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .personalized-greeting p {
            font-size: 15px;
            color: var(--text-light);
        }

        .section {
            padding: 0 20px 24px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 14px;
        }

        .section-title .highlight {
            color: var(--olive);
        }

        .my-mate-card {
            background: var(--white);
            border-radius: 20px;
            padding: 18px;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mate-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
        }

        .mate-avatar.olive { background: linear-gradient(135deg, #E8F0E3 0%, #D4E4CC 100%); }
        .mate-avatar.purple { background: linear-gradient(135deg, #EDE8F0 0%, #DDD4E4 100%); }
        .mate-avatar.pink { background: linear-gradient(135deg, #F5E6E8 0%, #EEDAD8 100%); }

        .my-mate-info { flex: 1; min-width: 0; }

        .my-mate-message {
            font-size: 14px;
            color: var(--text-dark);
            line-height: 1.5;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .my-mate-meta {
            font-size: 13px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .my-mate-name { font-weight: 500; color: var(--text-medium); }

        .mate-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .mate-card {
            background: var(--white);
            border-radius: 20px;
            padding: 16px 18px;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            gap: 14px;
            transition: all 0.2s;
        }

        .mate-card-info { flex: 1; min-width: 0; }

        .mate-card-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mate-card-name .badge {
            background: var(--olive);
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .mate-card-desc {
            font-size: 14px;
            color: var(--text-light);
            line-height: 1.4;
        }

        .mate-card-btn {
            background: var(--cream);
            border: none;
            padding: 10px 18px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            flex-shrink: 0;
        }

        .mate-card-btn:hover {
            background: var(--olive);
            color: white;
        }

        .bottom-input-area {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: var(--white);
            padding: 12px 16px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom, 0));
            border-top: 1px solid #F0F0F0;
        }

        .global-input-wrap {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #F5F5F5;
            border-radius: 24px;
            padding: 6px 6px 6px 20px;
        }

        .global-input {
            flex: 1;
            border: none;
            background: none;
            font-size: 15px;
            color: var(--text-dark);
            font-family: inherit;
            outline: none;
        }

        .global-input::placeholder { color: var(--text-light); }
        .global-input-prefix { 
            color: var(--olive); 
            font-weight: 600; 
            font-size: 15px; 
            flex-shrink: 0;
            white-space: nowrap;
        }

        /* Wispr Flow Ïä§ÌÉÄÏùº ÏùåÏÑ± Î≤ÑÌäº */
        .voice-btn {
            width: 42px;
            height: 42px;
            background: var(--text-dark);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
            position: relative;
        }

        .voice-btn:hover {
            transform: scale(1.05);
        }

        .voice-btn.recording {
            background: #FF4757;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.4); }
            50% { box-shadow: 0 0 0 12px rgba(255, 71, 87, 0); }
        }

        /* Sound Wave Icon */
        .sound-wave {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            height: 20px;
        }

        .sound-wave .bar {
            width: 3px;
            background: white;
            border-radius: 2px;
            transition: height 0.1s;
        }

        .sound-wave .bar:nth-child(1) { height: 8px; }
        .sound-wave .bar:nth-child(2) { height: 14px; }
        .sound-wave .bar:nth-child(3) { height: 20px; }
        .sound-wave .bar:nth-child(4) { height: 14px; }
        .sound-wave .bar:nth-child(5) { height: 8px; }

        .voice-btn.recording .sound-wave .bar {
            animation: soundWave 0.5s infinite ease-in-out alternate;
        }

        .voice-btn.recording .sound-wave .bar:nth-child(1) { animation-delay: 0s; }
        .voice-btn.recording .sound-wave .bar:nth-child(2) { animation-delay: 0.1s; }
        .voice-btn.recording .sound-wave .bar:nth-child(3) { animation-delay: 0.2s; }
        .voice-btn.recording .sound-wave .bar:nth-child(4) { animation-delay: 0.3s; }
        .voice-btn.recording .sound-wave .bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes soundWave {
            0% { height: 6px; }
            100% { height: 20px; }
        }

        .bottom-nav {
            display: flex;
            justify-content: space-around;
            padding: 8px 0 0;
            margin-top: 8px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px 16px;
            font-family: inherit;
        }

        .nav-item .icon { font-size: 20px; opacity: 0.4; }
        .nav-item.active .icon { opacity: 1; }

        .home-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 140px;
        }

        .empty-my-mate {
            background: var(--white);
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            box-shadow: var(--card-shadow);
        }

        .empty-my-mate p {
            font-size: 14px;
            color: var(--text-light);
        }

        /* ==================== ONBOARDING SCREEN ==================== */
        .onboarding-screen {
            background: linear-gradient(180deg, #E8F0E3 0%, #F5E6E8 40%, #FFFFFF 100%);
            padding: 60px 24px 40px;
        }

        .onboarding-screen.purple-theme {
            background: linear-gradient(180deg, #EDE8F0 0%, #F5E6E8 40%, #FFFFFF 100%);
        }

        .back-btn {
            position: absolute;
            top: 16px;
            left: 16px;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 12px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        .onboarding-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .onboarding-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .onboarding-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .onboarding-step {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        .onboarding-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-dark);
            line-height: 1.5;
        }

        .onboarding-subtitle {
            font-size: 14px;
            color: var(--text-medium);
            margin-top: 8px;
        }

        .onboarding-form {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .text-input {
            width: 100%;
            padding: 16px 20px;
            font-size: 17px;
            border: 2px solid transparent;
            border-radius: 16px;
            background: var(--white);
            color: var(--text-dark);
            text-align: center;
            font-family: inherit;
            box-shadow: var(--card-shadow);
            transition: all 0.2s;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--olive);
        }

        .text-input::placeholder { color: #B5B5B5; }

        .input-hint {
            font-size: 13px;
            color: var(--text-light);
            text-align: center;
            margin-top: 10px;
        }

        .options-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-btn {
            background: var(--white);
            border: 2px solid transparent;
            padding: 16px 20px;
            border-radius: 16px;
            font-size: 15px;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            text-align: left;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .option-btn:hover {
            border-color: var(--olive-light);
            background: #FAFAFA;
        }

        .option-btn.selected {
            border-color: var(--olive);
            background: linear-gradient(135deg, #F5F8F2 0%, #FFFFFF 100%);
        }

        .option-btn.selected.purple {
            border-color: var(--purple);
            background: linear-gradient(135deg, #F5F2F8 0%, #FFFFFF 100%);
        }

        .option-icon { font-size: 20px; }
        .option-text { flex: 1; }

        .option-check {
            width: 22px;
            height: 22px;
            border: 2px solid #DDD;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: transparent;
            transition: all 0.2s;
        }

        .option-btn.selected .option-check {
            border-color: var(--olive);
            background: var(--olive);
            color: white;
        }

        .option-btn.selected.purple .option-check {
            border-color: var(--purple);
            background: var(--purple);
        }

        .number-input-wrap {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .number-input {
            width: 100px;
            padding: 16px;
            font-size: 24px;
            font-weight: 600;
            border: 2px solid transparent;
            border-radius: 16px;
            background: var(--white);
            color: var(--text-dark);
            text-align: center;
            font-family: inherit;
            box-shadow: var(--card-shadow);
        }

        .number-input:focus {
            outline: none;
            border-color: var(--olive);
        }

        .number-suffix {
            font-size: 18px;
            color: var(--text-medium);
            font-weight: 500;
        }

        .onboarding-footer { padding-top: 20px; }

        .btn-primary {
            width: 100%;
            background: var(--olive);
            color: white;
            border: none;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-primary:hover { background: var(--olive-dark); }
        .btn-primary:disabled { background: #CCC; cursor: not-allowed; }
        .btn-primary.purple { background: var(--purple); }
        .btn-primary.purple:hover { background: #8A7995; }

        /* ==================== CHAT SCREEN ==================== */
        .chat-screen { background: #F8F8F8; }

        .chat-header {
            background: var(--white);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #F0F0F0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .chat-back-btn {
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dark);
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .chat-header-name {
            flex: 1;
            font-size: 17px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .chat-menu-btn {
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-medium);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
            padding-bottom: 100px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-date {
            text-align: center;
            padding: 8px 16px;
        }

        .chat-date span {
            background: rgba(0, 0, 0, 0.05);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            color: var(--text-light);
        }

        .message {
            display: flex;
            gap: 10px;
            animation: slideUp 0.3s ease;
        }

        .message.ai {
            align-self: flex-start;
            max-width: 85%;
        }

        .message.user {
            align-self: flex-end;
            max-width: 80%;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            align-self: flex-start;
        }

        .message-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .message-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-medium);
            margin-left: 4px;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .message.ai .message-bubble {
            background: var(--white);
            color: var(--text-dark);
            border-bottom-left-radius: 4px;
        }

        .message.user .message-bubble {
            background: var(--olive);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-light);
            margin-left: 4px;
        }

        .message.user .message-time {
            text-align: right;
            margin-right: 4px;
        }

        /* ÏùåÏÑ± Î©îÏãúÏßÄ ÌëúÏãú */
        .message-voice-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
            margin-left: 4px;
        }

        .message-voice-indicator svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        .profile-link {
            text-align: center;
            padding: 16px;
            margin-top: 8px;
        }

        .profile-link p {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .profile-link a {
            font-size: 14px;
            color: var(--text-medium);
            text-decoration: underline;
            cursor: pointer;
        }

        .typing-indicator {
            display: none;
            padding: 14px 18px;
            background: var(--white);
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
            margin-left: 46px;
        }

        .typing-indicator.show {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #C0C0C0;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .chat-input-area {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: var(--white);
            padding: 12px 16px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom, 0));
            border-top: 1px solid #F0F0F0;
        }

        .chat-input-wrap {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .chat-input-left {
            width: 36px;
            height: 36px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-medium);
            flex-shrink: 0;
        }

        .chat-input {
            flex: 1;
            padding: 10px 16px;
            font-size: 15px;
            border: none;
            background: #F5F5F5;
            border-radius: 20px;
            color: var(--text-dark);
            font-family: inherit;
            resize: none;
            max-height: 100px;
            line-height: 1.4;
        }

        .chat-input:focus {
            outline: none;
            background: #EFEFEF;
        }

        .chat-input::placeholder { color: var(--text-light); }

        .chat-voice-btn {
            width: 42px;
            height: 42px;
            background: var(--text-dark);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .chat-voice-btn svg { width: 20px; height: 20px; fill: white; }
        .chat-voice-btn.send-mode { background: var(--olive); }

        .chat-voice-btn.recording {
            background: #FF4757;
            animation: pulse 1.5s infinite;
        }

        /* ==================== VOICE MODE OVERLAY ==================== */
        .voice-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .voice-overlay.active {
            display: flex;
        }

        .voice-overlay-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            font-size: 24px;
            color: white;
            cursor: pointer;
        }

        .voice-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            margin-bottom: 24px;
        }

        .voice-status {
            font-size: 18px;
            color: white;
            margin-bottom: 40px;
            text-align: center;
        }

        .voice-status .listening {
            color: #FF4757;
        }

        .voice-status .speaking {
            color: #4ECDC4;
        }

        .voice-visualizer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            height: 80px;
            margin-bottom: 40px;
        }

        .voice-visualizer .bar {
            width: 6px;
            background: white;
            border-radius: 3px;
            transition: height 0.1s;
        }

        .voice-visualizer.listening .bar {
            animation: voiceWave 0.5s infinite ease-in-out alternate;
        }

        .voice-visualizer .bar:nth-child(1) { animation-delay: 0s; height: 20px; }
        .voice-visualizer .bar:nth-child(2) { animation-delay: 0.1s; height: 35px; }
        .voice-visualizer .bar:nth-child(3) { animation-delay: 0.2s; height: 50px; }
        .voice-visualizer .bar:nth-child(4) { animation-delay: 0.15s; height: 40px; }
        .voice-visualizer .bar:nth-child(5) { animation-delay: 0.25s; height: 55px; }
        .voice-visualizer .bar:nth-child(6) { animation-delay: 0.1s; height: 45px; }
        .voice-visualizer .bar:nth-child(7) { animation-delay: 0.2s; height: 30px; }

        @keyframes voiceWave {
            0% { transform: scaleY(0.3); opacity: 0.5; }
            100% { transform: scaleY(1); opacity: 1; }
        }

        .voice-visualizer.speaking .bar {
            background: #4ECDC4;
            animation: speakWave 0.8s infinite ease-in-out alternate;
        }

        @keyframes speakWave {
            0% { transform: scaleY(0.5); }
            100% { transform: scaleY(1); }
        }

        .voice-transcript {
            max-width: 300px;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 16px;
            line-height: 1.6;
            min-height: 50px;
        }

        .voice-mic-btn {
            width: 80px;
            height: 80px;
            background: #FF4757;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-top: 40px;
            transition: all 0.2s;
        }

        .voice-mic-btn:hover {
            transform: scale(1.05);
        }

        .voice-mic-btn.listening {
            animation: pulse 1.5s infinite;
        }

        .voice-mic-btn svg {
            width: 36px;
            height: 36px;
            fill: white;
        }
        
        .voice-mic-btn svg rect {
            transform-origin: center;
        }
        
        .voice-mic-btn.listening svg rect {
            animation: micWave 0.6s ease-in-out infinite alternate;
        }
        .voice-mic-btn.listening svg rect:nth-child(1) { animation-delay: 0s; }
        .voice-mic-btn.listening svg rect:nth-child(2) { animation-delay: 0.1s; }
        .voice-mic-btn.listening svg rect:nth-child(3) { animation-delay: 0.2s; }
        .voice-mic-btn.listening svg rect:nth-child(4) { animation-delay: 0.3s; }
        .voice-mic-btn.listening svg rect:nth-child(5) { animation-delay: 0.4s; }
        
        @keyframes micWave {
            from { transform: scaleY(0.5); }
            to { transform: scaleY(1); }
        }

        .voice-hint {
            position: absolute;
            bottom: 40px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
        }

        /* TTS Ïû¨ÏÉù Ï§ë ÌëúÏãú */
        .speaking-indicator {
            display: none;
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--olive);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            align-items: center;
            gap: 8px;
            z-index: 100;
        }

        .speaking-indicator.show {
            display: flex;
        }

        .speaking-indicator .mini-wave {
            display: flex;
            gap: 2px;
        }

        .speaking-indicator .mini-wave span {
            width: 3px;
            height: 12px;
            background: white;
            border-radius: 2px;
            animation: miniWave 0.5s infinite ease-in-out alternate;
        }

        .speaking-indicator .mini-wave span:nth-child(1) { animation-delay: 0s; }
        .speaking-indicator .mini-wave span:nth-child(2) { animation-delay: 0.1s; }
        .speaking-indicator .mini-wave span:nth-child(3) { animation-delay: 0.2s; }

        @keyframes miniWave {
            0% { height: 6px; }
            100% { height: 14px; }
        }

        @media (max-width: 380px) {
            .home-title { font-size: 22px; }
            .onboarding-title { font-size: 20px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ==================== HOME SCREEN ==================== -->
        <div class="screen home-screen active" id="homeScreen">
            <div class="home-header">
                <button class="home-header-btn" onclick="openSideMenu()" id="menuBtn">‚ò∞</button>
            </div>

            <div class="home-content" id="homeContent">
                <!-- ÎèôÏ†ÅÏúºÎ°ú Î†åÎçîÎßÅÎê® -->
            </div>

            <!-- Side Menu -->
            <div class="side-menu-overlay" id="sideMenuOverlay" onclick="closeSideMenu()"></div>
            <div class="side-menu" id="sideMenu">
                <div class="side-menu-header">
                    <button class="side-menu-close" onclick="closeSideMenu()">√ó</button>
                    <h2>ÎßàÎçîÏä§Î≤†Ïù¥ÎπÑ</h2>
                    <p>ÏóÑÎßàÏùò Î™®Îì† Ïó¨Ï†ïÏùÑ Ìï®Íªò</p>
                </div>
                <div class="side-menu-content" id="sideMenuContent">
                    <!-- ÎèôÏ†ÅÏúºÎ°ú Î†åÎçîÎßÅÎê® -->
                </div>
            </div>

            <div class="bottom-input-area">
                <div class="global-input-wrap">
                    <span class="global-input-prefix">@ÎßòÍ≥Å</span>
                    <input type="text" class="global-input" placeholder="ÏóêÍ≤å Ïù¥ÏïºÍ∏∞Ìï¥Î≥¥ÏÑ∏Ïöî" id="globalInput">
                    <button class="voice-btn" onclick="startGlobalVoice()">
                        <div class="sound-wave">
                            <div class="bar"></div>
                            <div class="bar"></div>
                            <div class="bar"></div>
                            <div class="bar"></div>
                            <div class="bar"></div>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- ==================== ONBOARDING SCREEN ==================== -->
        <div class="screen onboarding-screen" id="onboardingScreen">
            <button class="back-btn" onclick="goBack()">‚Üê</button>
            
            <div class="onboarding-content">
                <div class="onboarding-header">
                    <div class="onboarding-avatar" id="onboardingAvatar">üíö</div>
                    <div class="onboarding-step" id="onboardingStep">1/3</div>
                    <h2 class="onboarding-title" id="onboardingTitle">ÏßàÎ¨∏</h2>
                    <p class="onboarding-subtitle" id="onboardingSubtitle"></p>
                </div>

                <div class="onboarding-form" id="onboardingForm"></div>

                <div class="onboarding-footer">
                    <button class="btn-primary" id="onboardingNextBtn" onclick="nextStep()">Îã§Ïùå</button>
                </div>
            </div>
        </div>

        <!-- ==================== CHAT SCREEN ==================== -->
        <div class="screen chat-screen" id="chatScreen">
            <div class="chat-header">
                <button class="chat-back-btn" onclick="goToHome()">‚Äπ</button>
                <div class="chat-header-avatar" id="chatAvatar">üíö</div>
                <div class="chat-header-name" id="chatHeaderName">ÎßòÍ≥Å</div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="chat-date"><span id="chatDate"></span></div>
                <div class="typing-indicator" id="typingIndicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>

            <div class="speaking-indicator" id="speakingIndicator">
                <div class="mini-wave">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <span>ÎßòÍ≥ÅÏù¥ ÎßêÌïòÍ≥† ÏûàÏñ¥Ïöî...</span>
            </div>

            <div class="chat-input-area">
                <div class="chat-input-wrap">
                    <button class="chat-input-left">+</button>
                    <textarea class="chat-input" id="chatInput" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî." rows="1"></textarea>
                    <button class="chat-voice-btn" id="chatSendBtn" onclick="handleChatButton()">
                        <div class="sound-wave" id="chatBtnWave">
                            <div class="bar"></div>
                            <div class="bar"></div>
                            <div class="bar"></div>
                            <div class="bar"></div>
                            <div class="bar"></div>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- ==================== VOICE OVERLAY ==================== -->
        <div class="voice-overlay" id="voiceOverlay">
            <button class="voice-overlay-close" onclick="closeVoiceMode()">‚úï</button>
            
            <div class="voice-avatar" id="voiceAvatar">üíö</div>
            
            <div class="voice-status" id="voiceStatus">
                <span class="listening">Îì£Í≥† ÏûàÏñ¥Ïöî...</span>
            </div>

            <div class="voice-visualizer listening" id="voiceVisualizer">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>

            <div class="voice-transcript" id="voiceTranscript"></div>

            <button class="voice-mic-btn listening" id="voiceMicBtn" onclick="toggleVoiceRecording()">
                <svg viewBox="0 0 24 24" class="wave-icon">
                    <rect x="2" y="8" width="3" height="8" rx="1.5"/>
                    <rect x="7" y="5" width="3" height="14" rx="1.5"/>
                    <rect x="12" y="2" width="3" height="20" rx="1.5"/>
                    <rect x="17" y="5" width="3" height="14" rx="1.5"/>
                    <rect x="22" y="8" width="3" height="8" rx="1.5"/>
                </svg>
            </button>

            <div class="voice-hint">ÎßàÏù¥ÌÅ¨ Î≤ÑÌäºÏùÑ ÎàåÎü¨ ÎåÄÌôîÌïòÏÑ∏Ïöî</div>
        </div>
        
        <!-- ==================== HISTORY MODAL ==================== -->
        <div class="history-modal" id="historyModal">
            <div class="history-modal-header">
                <button class="history-modal-back" onclick="closeHistoryModal()">‚Üê</button>
                <span class="history-modal-title">Ï†ÑÏ≤¥ ÎåÄÌôî Í∏∞Î°ù</span>
            </div>
            <div class="history-modal-content" id="historyModalContent">
                <!-- ÎèôÏ†ÅÏúºÎ°ú Ï±ÑÏõåÏßê -->
            </div>
        </div>
    </div>

    <script>
        // ==================== STATE ====================
        let currentMate = null;
        let currentStep = 0;
        let currentQuickAction = null; // Quick Action Îß•ÎùΩ Ï†ÄÏû•
        let onboardingData = {};
        let conversationHistory = [];
        let visitorId = null; // ÏÇ¨Ïö©Ïûê ÏãùÎ≥ÑÏûê
        let isLoading = false;

        // Voice state
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let isRecording = false;
        let isVoiceMode = false;
        let isSpeaking = false;
        let isGlobalInputVoice = false; // globalInputÏóêÏÑú ÏùåÏÑ±Ïù∏Ïãù ÏãúÏûë Ïó¨Î∂Ä
// ÏÇ¨Ïö©Ïûê Í≥†Ïú† ID ÏÉùÏÑ±/Í∞ÄÏ†∏Ïò§Í∏∞
        function getVisitorId() {
            let id = localStorage.getItem('momgyeot_visitor_id');
            if (!id) {
                id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('momgyeot_visitor_id', id);
            }
            return id;
        }

        // ÎåÄÌôî Í∏∞Î°ù ÏÑúÎ≤ÑÏóê Ï†ÄÏû•
        async function saveMessage(role, content) {
            try {
                await fetch('/api/history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: visitorId, role, content })
                });
            } catch (e) {
                console.error('Î©îÏãúÏßÄ Ï†ÄÏû• Ïã§Ìå®:', e);
            }
        }

        // ÎåÄÌôî Í∏∞Î°ù Î∂àÎü¨Ïò§Í∏∞
        async function loadHistory() {
            try {
                const res = await fetch(`/api/history?user_id=${visitorId}`);
                const data = await res.json();
                return data.messages || [];
            } catch (e) {
                console.error('Í∏∞Î°ù Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:', e);
                return [];
            }
        }        // ==================== MATE CONFIG ====================
        const mateConfig = {
            prep: {
                name: 'ÏòàÎπÑÎßòÍ≥Å',
                emoji: 'üíú',
                avatarClass: 'purple',
                isPurple: true,
                steps: [
                    { type: 'text', key: 'nickname', title: 'Ìé∏ÌïòÍ≤å Î∂àÎü¨ÎìúÎ¶¥\nÏù¥Î¶ÑÏùÑ ÏïåÎ†§Ï£ºÏÑ∏Ïöî', subtitle: 'Ïù¥Î¶ÑÏù¥ÎÇò ÎãâÎÑ§ÏûÑ Î™®Îëê Ï¢ãÏïÑÏöî', placeholder: 'Ïòà: ÌïòÎäò, Î≥¥ÎØ∏', hint: 'ÌïúÍ∏Ä, ÏòÅÎ¨∏ 2~10Ïûê' },
                    { type: 'select', key: 'duration', title: 'Ï§ÄÎπÑÌïòÏã† ÏßÄ\nÏñºÎßàÎÇò ÎêòÏÖ®Ïñ¥Ïöî?', options: [
                        { value: 'start', label: 'Ïù¥Ï†ú Îßâ ÏãúÏûëÌñàÏñ¥Ïöî', icon: 'üå±' },
                        { value: '6months', label: '6Í∞úÏõî Ï†ïÎèÑ ÎêêÏñ¥Ïöî', icon: 'üçÉ' },
                        { value: '1year', label: '1ÎÖÑ Ï†ïÎèÑ ÎêêÏñ¥Ïöî', icon: 'üåø' },
                        { value: 'over1year', label: '1ÎÖÑ ÎÑòÏóàÏñ¥Ïöî', icon: 'üå≥' }
                    ]},
                    { type: 'select', key: 'situation', title: 'ÏßÄÍ∏à Ïñ¥Îñ§ ÏÉÅÌô©Ïù¥ÏÑ∏Ïöî?', options: [
                        { value: 'natural', label: 'ÏûêÏó∞ ÏûÑÏã† ÏãúÎèÑ Ï§ëÏù¥ÏóêÏöî', icon: 'ü§ç' },
                        { value: 'hospital', label: 'Î≥ëÏõê ÏÉÅÎã¥/Í≤ÄÏÇ¨ Ï§ëÏù¥ÏóêÏöî', icon: 'üè•' },
                        { value: 'treatment', label: 'ÏãúÏà† Ï§ÄÎπÑ ÎòêÎäî ÏßÑÌñâ Ï§ëÏù¥ÏóêÏöî', icon: 'üíâ' },
                        { value: 'rest', label: 'Ïû†Ïãú Ïâ¨Í≥† ÏûàÏñ¥Ïöî', icon: '‚òÅÔ∏è' }
                    ]},
                    { type: 'select', key: 'need', title: 'Ï†ÄÌïúÌÖå Ïñ¥Îñ§ ÎèÑÏõÄÏù¥\nÌïÑÏöîÌïòÏÑ∏Ïöî?', options: [
                        { value: 'info', label: 'Ï†ïÎ≥¥Í∞Ä Í∂ÅÍ∏àÌï¥Ïöî', icon: 'üìö' },
                        { value: 'talk', label: 'ÎßàÏùåÏùÑ ÎÇòÎàÑÍ≥† Ïã∂Ïñ¥Ïöî', icon: 'üíú' },
                        { value: 'company', label: 'Í∑∏ÎÉ• Í≥ÅÏóê ÏûàÏñ¥Ï£ºÏÑ∏Ïöî', icon: 'ü§ó' }
                    ]}
                ],
                getWelcome: (data) => `ÏïàÎÖïÌïòÏÑ∏Ïöî ${data.nickname}, Ï†ÄÎäî ÏòàÎπÑÎßòÍ≥ÅÏù¥ÏóêÏöî.\n\n${getDurationText(data.duration)} Ï§ÄÎπÑÌï¥Ïò§ÏÖ®Íµ∞Ïöî.\n${getSituationText(data.situation)}\n\nÏñ¥Îñ§ Ïù¥ÏïºÍ∏∞Îì† Ìé∏ÌïòÍ≤å ÎÇòÎà†Ï£ºÏÑ∏Ïöî.\nÏ†ÄÎäî Ìï≠ÏÉÅ Ïó¨Í∏∞ ÏûàÏùÑÍ≤åÏöî üíú`
            },
            pregnancy: {
                name: 'ÏûÑÏã†ÎßòÍ≥Å',
                emoji: 'ü§∞',
                avatarClass: 'pink',
                isPurple: false,
                steps: [
                    { type: 'text', key: 'nickname', title: 'Ïñ¥ÎñªÍ≤å Î∂àÎü¨ÎìúÎ¶¥ÍπåÏöî?', subtitle: 'ÌÉúÎ™ÖÏù¥ÎÇò ÎãâÎÑ§ÏûÑ Î™®Îëê Ï¢ãÏïÑÏöî', placeholder: 'Ïòà: Ï±ÑÎ¶ºÎßò, ÏΩ©Ïù¥Îßò', hint: 'ÌïúÍ∏Ä, ÏòÅÎ¨∏ 2~10Ïûê' },
                    { type: 'number', key: 'weeks', title: 'ÌòÑÏû¨ ÏûÑÏã† Î™á Ï£ºÏ∞®Ïù¥ÏÑ∏Ïöî?', suffix: 'Ï£º', min: 4, max: 42 },
                    { type: 'select', key: 'firstBaby', title: 'Ï≤´ ÏïÑÏù¥Ïù∏Í∞ÄÏöî?', options: [
                        { value: 'yes', label: 'ÎÑ§, Ï≤´ ÏïÑÏù¥ÏòàÏöî', icon: 'üë∂' },
                        { value: 'no', label: 'ÏïÑÎãàÏöî, ÎëòÏß∏/ÏÖãÏß∏ÏòàÏöî', icon: 'üë®‚Äçüë©‚Äçüëß' }
                    ]},
                    { type: 'select', key: 'concern', title: 'ÏöîÏ¶ò Í∞ÄÏû• Ïã†Í≤Ω Ïì∞Ïù¥Îäî Í±¥\nÎ¨¥ÏóáÏù∏Í∞ÄÏöî?', options: [
                        { value: 'body', label: 'ÏûÖÎçß/Î™∏Ïùò Î≥ÄÌôî', icon: 'ü§¢' },
                        { value: 'health', label: 'Í≤ÄÏÇ¨/ÌÉúÏïÑ Í±¥Í∞ï', icon: 'üè•' },
                        { value: 'birth', label: 'Ï∂úÏÇ∞ Ï§ÄÎπÑ', icon: 'üçº' },
                        { value: 'emotion', label: 'ÎßàÏùåÏù¥ ÌûòÎì§Ïñ¥Ïöî', icon: 'üíö' }
                    ]}
                ],
                getWelcome: (data) => `ÏïàÎÖïÌïòÏÑ∏Ïöî ${data.nickname}, Ï†ÄÎäî ÏûÑÏã†ÎßòÍ≥ÅÏù¥ÏóêÏöî.\n\n${data.weeks}Ï£ºÏ∞®ÏãúÍµ∞Ïöî! ${getWeeksComment(data.weeks)}\n\nÏó¥ Îã¨Ïùò Ïó¨Ï†ï, ÏÑ§Î†òÍ≥º Í±±Ï†ï Î™®Îëê Ìï®Íªò ÎÇòÎà†Ïöî.\nÏïûÏúºÎ°ú Ï¶êÍ≤ÅÍ≤å Ìï®ÍªòÌï¥Ïöî! üíö`
            },
            infant: {
                name: 'ÏÉàÏãπÎßòÍ≥Å',
                emoji: 'üë∂',
                avatarClass: 'olive',
                isPurple: false,
                steps: [
                    { type: 'text', key: 'nickname', title: 'Ïñ¥ÎñªÍ≤å Î∂àÎü¨ÎìúÎ¶¥ÍπåÏöî?', subtitle: 'ÏïÑÏù¥ Ïù¥Î¶ÑÏù¥ÎÇò ÎãâÎÑ§ÏûÑ Î™®Îëê Ï¢ãÏïÑÏöî', placeholder: 'Ïòà: ÌïòÏ§ÄÎßò, ÏÑúÏïÑÎßò', hint: 'ÌïúÍ∏Ä, ÏòÅÎ¨∏ 2~10Ïûê' },
                    { type: 'select', key: 'babyAge', title: 'ÏïÑÍ∏∞Í∞Ä ÌÉúÏñ¥ÎÇú ÏßÄ\nÏñºÎßàÎÇò ÎêêÎÇòÏöî?', options: [
                        { value: 'newborn', label: 'Ïã†ÏÉùÏïÑ (0~3Í∞úÏõî)', icon: 'üê£' },
                        { value: '4-6', label: '4~6Í∞úÏõî', icon: 'üê•' },
                        { value: '7-12', label: '7~12Í∞úÏõî', icon: 'üê§' },
                        { value: '13-24', label: '13~24Í∞úÏõî', icon: 'üêî' }
                    ]},
                    { type: 'select', key: 'feeding', title: 'ÏàòÏú† Î∞©Î≤ïÏùÄ Ïñ¥ÎñªÍ≤å ÎêòÏÑ∏Ïöî?', options: [
                        { value: 'breast', label: 'ÏôÑÏ†Ñ Î™®Ïú†ÏàòÏú†', icon: 'ü§±' },
                        { value: 'mixed', label: 'ÌòºÌï© ÏàòÏú†', icon: 'üçº' },
                        { value: 'formula', label: 'Î∂ÑÏú† ÏàòÏú†', icon: 'üß¥' },
                        { value: 'weaning', label: 'Ïù¥Ïú†Ïãù ÏßÑÌñâ Ï§ë', icon: 'ü•£' }
                    ]},
                    { type: 'select', key: 'concern', title: 'ÏöîÏ¶ò Í∞ÄÏû• Í≥†ÎØºÏù∏ Í±¥\nÎ¨¥ÏóáÏù∏Í∞ÄÏöî?', options: [
                        { value: 'feeding', label: 'ÏàòÏú†/Ïù¥Ïú†Ïãù', icon: 'üçº' },
                        { value: 'sleep', label: 'ÏàòÎ©¥', icon: 'üò¥' },
                        { value: 'development', label: 'Î∞úÎã¨/Í±¥Í∞ï', icon: 'üìà' },
                        { value: 'tired', label: 'Ïú°ÏïÑ ÌîºÎ°ú', icon: 'üòÆ‚Äçüí®' }
                    ]}
                ],
                getWelcome: (data) => `ÏïàÎÖïÌïòÏÑ∏Ïöî ${data.nickname}, Ï†ÄÎäî ÏÉàÏãπÎßòÍ≥ÅÏù¥ÏóêÏöî.\n\n${getBabyAgeText(data.babyAge)} ÏïÑÍ∏∞Î•º ÌÇ§Ïö∞Í≥† Í≥ÑÏãúÍµ∞Ïöî.\nÏú°ÏïÑÏùò ÌïòÎ£®ÌïòÎ£®, Ï†ïÎßê Í≥†ÏÉù ÎßéÏúºÏÑ∏Ïöî.\n\nÏïûÏúºÎ°ú Ï¶êÍ≤ÅÍ≤å Ìï®ÍªòÌï¥Ïöî! üíö`
            },
            toddler: {
                name: 'Ïö∞Î¶¨ÎßòÍ≥Å',
                emoji: 'üßí',
                avatarClass: 'olive',
                isPurple: false,
                steps: [
                    { type: 'text', key: 'nickname', title: 'Ïñ¥ÎñªÍ≤å Î∂àÎü¨ÎìúÎ¶¥ÍπåÏöî?', subtitle: 'ÏïÑÏù¥ Ïù¥Î¶ÑÏù¥ÎÇò ÎãâÎÑ§ÏûÑ Î™®Îëê Ï¢ãÏïÑÏöî', placeholder: 'Ïòà: ÏßÄÏö∞Îßò, ÎØºÏÑúÎßò', hint: 'ÌïúÍ∏Ä, ÏòÅÎ¨∏ 2~10Ïûê' },
                    { type: 'select', key: 'childAge', title: 'ÏïÑÏù¥ ÎÇòÏù¥Í∞Ä Ïñ¥ÎñªÍ≤å ÎêòÎÇòÏöî?', options: [
                        { value: '2-3', label: '2~3ÏÑ∏', icon: 'üë∂' },
                        { value: '4-5', label: '4~5ÏÑ∏', icon: 'üßí' },
                        { value: '6-7', label: '6~7ÏÑ∏', icon: 'üë¶' }
                    ]},
                    { type: 'select', key: 'institution', title: 'Í∏∞Í¥ÄÏóê Îã§ÎãàÍ≥† ÏûàÎÇòÏöî?', options: [
                        { value: 'daycare', label: 'Ïñ¥Î¶∞Ïù¥Ïßë Îã§ÎÖÄÏöî', icon: 'üè´' },
                        { value: 'kindergarten', label: 'Ïú†ÏπòÏõê Îã§ÎÖÄÏöî', icon: 'üéí' },
                        { value: 'none', label: 'ÏïÑÏßÅ Ïïà Îã§ÎÖÄÏöî', icon: 'üè†' }
                    ]},
                    { type: 'select', key: 'concern', title: 'ÏöîÏ¶ò Í∞ÄÏû• Í≥†ÎØºÏù∏ Í±¥\nÎ¨¥ÏóáÏù∏Í∞ÄÏöî?', options: [
                        { value: 'discipline', label: 'ÌõàÏú°/ÎñºÏì∞Í∏∞', icon: 'üò§' },
                        { value: 'adaptation', label: 'Í∏∞Í¥Ä Ï†ÅÏùë', icon: 'üè´' },
                        { value: 'sibling', label: 'ÌòïÏ†ú Í¥ÄÍ≥Ñ', icon: 'üëßüë¶' },
                        { value: 'development', label: 'Î∞úÎã¨ Í≥†ÎØº', icon: 'üìä' }
                    ]}
                ],
                getWelcome: (data) => `ÏïàÎÖïÌïòÏÑ∏Ïöî ${data.nickname}, Ï†ÄÎäî Ïö∞Î¶¨ÎßòÍ≥ÅÏù¥ÏóêÏöî.\n\n${getChildAgeText(data.childAge)} ÏïÑÏù¥Î•º ÌÇ§Ïö∞Í≥† Í≥ÑÏãúÍµ∞Ïöî.\nÏïÑÏù¥ÏôÄ Ìï®Íªò ÏÑ±Ïû•ÌïòÎäî ÏöîÏ¶ò, ÎßéÏù¥ Î∞îÏÅòÏãúÏ£†?\n\nÏïûÏúºÎ°ú Ï¶êÍ≤ÅÍ≤å Ìï®ÍªòÌï¥Ïöî! üíö`
            }
        };

        // Helper functions
        function getDurationText(val) {
            const map = { 'start': 'Ïù¥Ï†ú Îßâ', '6months': '6Í∞úÏõî Ï†ïÎèÑ', '1year': '1ÎÖÑ Ï†ïÎèÑ', 'over1year': '1ÎÖÑ ÎÑòÍ≤å' };
            return map[val] || '';
        }
        function getSituationText(val) {
            const map = {
                'natural': 'ÏûêÏó∞ ÏûÑÏã†ÏùÑ ÏãúÎèÑÌïòÍ≥† Í≥ÑÏãúÎäîÍµ∞Ïöî.',
                'hospital': 'Î≥ëÏõêÏóêÏÑú ÏÉÅÎã¥Î∞õÍ≥† Í≥ÑÏãúÎäîÍµ∞Ïöî.',
                'treatment': 'ÏãúÏà†ÏùÑ Ï§ÄÎπÑÌïòÍ±∞ÎÇò ÏßÑÌñâ Ï§ëÏù¥ÏãúÍµ∞Ïöî.',
                'rest': 'Ïû†Ïãú Ïâ¨Î©¥ÏÑú ÎßàÏùåÏùÑ Ï∂îÏä§Î•¥Îäî Ï§ëÏù¥ÏãúÍµ∞Ïöî.'
            };
            return map[val] || '';
        }
        function getWeeksComment(weeks) {
            if (weeks <= 12) return 'Ï¥àÍ∏∞Îùº Ï°∞Ïã¨Ïä§Îü¨Ïö¥ ÏãúÍ∏∞Ï£†.';
            if (weeks <= 27) return 'ÏïàÏ†ïÍ∏∞Ïóê Ï†ëÏñ¥ÎìúÏÖ®ÎÑ§Ïöî.';
            return 'Ïù¥Ï†ú ÎßâÎ∞îÏßÄÎÑ§Ïöî!';
        }
        function getBabyAgeText(val) {
            const map = { 'newborn': 'Ïã†ÏÉùÏïÑ', '4-6': '4~6Í∞úÏõî Îêú', '7-12': '7~12Í∞úÏõî Îêú', '13-24': 'Îèå ÏßÄÎÇú' };
            return map[val] || '';
        }
        function getChildAgeText(val) {
            const map = { '2-3': '2~3ÏÑ∏', '4-5': '4~5ÏÑ∏', '6-7': '6~7ÏÑ∏' };
            return map[val] || '';
        }

        // System prompts
        const systemPrompts = {
            base: `ÎãπÏã†ÏùÄ "ÎßòÍ≥Å"ÏûÖÎãàÎã§. ÎßàÎçîÏä§Î≤†Ïù¥ÎπÑÏùò AI ÎèôÎ∞òÏûêÏûÖÎãàÎã§.
## ÌïµÏã¨ Ïó≠Ìï†
- Ï†ïÏÑúÏ†Å Í≥µÍ∞êÍ≥º ÏßÄÏßÄ
- ÌåêÎã® ÏóÜÏù¥ Î™®Îì† ÏÑ†ÌÉù Ï°¥Ï§ë
## ÎßêÌà¨
- Ìé∏ÏïàÌïú Ï°¥ÎåìÎßê, Î∂ÄÎìúÎü¨Ïö¥ Ïñ¥ÎØ∏
- ÏßßÏùÄ Î¨∏Ïû•, 3-5Ï§Ñ
## ÏúÑÍ∏∞ Í∞êÏßÄ
"Ï£ΩÍ≥†Ïã∂", "ÏÇ¨ÎùºÏßÄÍ≥†Ïã∂" Í∞êÏßÄ Ïãú ‚Üí Í≥µÍ∞ê + ÏûêÏÇ¥ÏòàÎ∞©ÏÉÅÎã¥Ï†ÑÌôî 1393 ÏïàÎÇ¥`,
            prep: `\n## ÏòàÎπÑÎßòÍ≥Å Í∑úÏπô\n- Ïù¥Î™®ÏßÄ: üíú ü§ç üå∏\n- Í∏àÏßÄ: üë∂ üçº ü§∞, "Í∏çÏ†ïÏ†ÅÏúºÎ°ú", "Îã§ÏùåÏóî Îê† Í±∞ÏòàÏöî"\n- ÎßàÎ¨¥Î¶¨: üíú`,
            pregnancy: `\n## ÏûÑÏã†ÎßòÍ≥Å Í∑úÏπô\n- ÏùòÌïôÏ†Å Ï°∞Ïñ∏ÏùÄ Î≥ëÏõê Í∂åÏú†\n- ÎßàÎ¨¥Î¶¨: üíö`,
            infant: `\n## ÏÉàÏãπÎßòÍ≥Å Í∑úÏπô\n- "Í∑∏Í≤ÉÎèÑ Î∞©Î≤ïÏù¥ÏóêÏöî" ÏûêÏ£º ÏÇ¨Ïö©\n- ÎßàÎ¨¥Î¶¨: üíö`,
            toddler: `\n## Ïö∞Î¶¨ÎßòÍ≥Å Í∑úÏπô\n- ÏñëÏú° Î∞©Ïãù ÎπÑÌåê Í∏àÏßÄ\n- ÎßàÎ¨¥Î¶¨: üíö`
        };

        // ==================== VOICE RECOGNITION ====================
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.log('Speech recognition not supported');
                return false;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.continuous = false;
            recognition.interimResults = true;

            recognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                
                if (isVoiceMode) {
                    document.getElementById('voiceTranscript').textContent = transcript;
                } else if (isGlobalInputVoice) {
                    // globalInputÏóê Ïã§ÏãúÍ∞Ñ ÌëúÏãú
                    document.getElementById('globalInput').value = transcript;
                }

                if (event.results[event.resultIndex].isFinal) {
                    if (isVoiceMode) {
                        processVoiceInput(transcript);
                    } else if (isGlobalInputVoice) {
                        // globalInputÏóê ÏµúÏ¢Ö Í≤∞Í≥º ÏûÖÎ†• ÌõÑ Î¶¨ÏÖã
                        document.getElementById('globalInput').value = transcript;
                        isGlobalInputVoice = false;
                        updateGlobalVoiceUI(false);
                    } else {
                        document.getElementById('chatInput').value = transcript;
                        sendMessage(true);
                    }
                }
            };

            recognition.onend = () => {
                isRecording = false;
                if (isGlobalInputVoice) {
                    isGlobalInputVoice = false;
                    updateGlobalVoiceUI(false);
                }
                updateRecordingUI();
            };

            recognition.onerror = (event) => {
                console.log('Speech recognition error:', event.error);
                isRecording = false;
                if (isGlobalInputVoice) {
                    isGlobalInputVoice = false;
                    updateGlobalVoiceUI(false);
                }
                updateRecordingUI();
            };

            return true;
        }

        function startRecording() {
            if (!recognition && !initSpeechRecognition()) {
                alert('ÏùåÏÑ± Ïù∏ÏãùÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Î∏åÎùºÏö∞Ï†ÄÏûÖÎãàÎã§.');
                return;
            }

            try {
                recognition.start();
                isRecording = true;
                updateRecordingUI();
            } catch (e) {
                console.log('Recognition error:', e);
            }
        }

        function stopRecording() {
            if (recognition) {
                recognition.stop();
            }
            isRecording = false;
            updateRecordingUI();
        }

        function updateRecordingUI() {
            const chatBtn = document.getElementById('chatSendBtn');
            const voiceMicBtn = document.getElementById('voiceMicBtn');
            const voiceVisualizer = document.getElementById('voiceVisualizer');

            if (isRecording) {
                if (chatBtn) chatBtn.classList.add('recording');
                if (voiceMicBtn) voiceMicBtn.classList.add('listening');
                if (voiceVisualizer) {
                    voiceVisualizer.classList.add('listening');
                    voiceVisualizer.classList.remove('speaking');
                }
            } else {
                if (chatBtn) chatBtn.classList.remove('recording');
                if (voiceMicBtn) voiceMicBtn.classList.remove('listening');
                if (voiceVisualizer) voiceVisualizer.classList.remove('listening');
            }
        }

        // ==================== TEXT TO SPEECH ====================
        function speak(text) {
            if (!synthesis) return;

            synthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = 0.95;
            utterance.pitch = 1.1;

            utterance.onstart = () => {
                isSpeaking = true;
                const indicator = document.getElementById('speakingIndicator');
                if (indicator) indicator.classList.add('show');
                
                if (isVoiceMode) {
                    const status = document.getElementById('voiceStatus');
                    const visualizer = document.getElementById('voiceVisualizer');
                    if (status) status.innerHTML = '<span class="speaking">ÎßêÌïòÍ≥† ÏûàÏñ¥Ïöî...</span>';
                    if (visualizer) {
                        visualizer.classList.remove('listening');
                        visualizer.classList.add('speaking');
                    }
                }
            };

            utterance.onend = () => {
                isSpeaking = false;
                const indicator = document.getElementById('speakingIndicator');
                if (indicator) indicator.classList.remove('show');
                
                if (isVoiceMode) {
                    const status = document.getElementById('voiceStatus');
                    const visualizer = document.getElementById('voiceVisualizer');
                    if (status) status.innerHTML = '<span class="listening">Îì£Í≥† ÏûàÏñ¥Ïöî...</span>';
                    if (visualizer) visualizer.classList.remove('speaking');
                    // ÏûêÎèôÏúºÎ°ú Îã§Ïãú Îì£Í∏∞ ÏãúÏûë
                    setTimeout(() => {
                        if (isVoiceMode) startRecording();
                    }, 500);
                }
            };

            synthesis.speak(utterance);
        }

        function stopSpeaking() {
            if (synthesis) {
                synthesis.cancel();
            }
            isSpeaking = false;
            const indicator = document.getElementById('speakingIndicator');
            if (indicator) indicator.classList.remove('show');
        }

        // ==================== VOICE MODE ====================
        function startGlobalVoice() {
            const saved = localStorage.getItem('myMateData');
            
            if (!saved) {
                alert('Î®ºÏ†Ä ÎßòÍ≥ÅÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            // Ïù¥ÎØ∏ ÎÖπÏùå Ï§ëÏù¥Î©¥ Ï§ëÏßÄ
            if (isGlobalInputVoice) {
                stopRecording();
                isGlobalInputVoice = false;
                updateGlobalVoiceUI(false);
                return;
            }
            
            // globalInput ÏùåÏÑ±Ïù∏Ïãù ÏãúÏûë
            isGlobalInputVoice = true;
            updateGlobalVoiceUI(true);
            startRecording();
        }
        
        function updateGlobalVoiceUI(isActive) {
            const voiceBtn = document.querySelector('.global-input-wrap .voice-btn');
            if (voiceBtn) {
                if (isActive) {
                    voiceBtn.style.background = '#FF6B6B';
                    voiceBtn.innerHTML = 'üéôÔ∏è';
                } else {
                    voiceBtn.style.background = 'var(--olive-light)';
                    voiceBtn.innerHTML = 'üé§';
                }
            }
        }

        function openVoiceMode() {
            isVoiceMode = true;
            const mate = mateConfig[currentMate];
            
            const overlay = document.getElementById('voiceOverlay');
            const avatar = document.getElementById('voiceAvatar');
            const transcript = document.getElementById('voiceTranscript');
            const status = document.getElementById('voiceStatus');
            
            if (overlay && avatar && transcript && status) {
                overlay.classList.add('active');
                avatar.textContent = mate.emoji;
                avatar.className = `voice-avatar ${mate.avatarClass}`;
                transcript.textContent = '';
                status.innerHTML = '<span class="listening">Îì£Í≥† ÏûàÏñ¥Ïöî...</span>';
                
                setTimeout(() => startRecording(), 500);
            }
        }

        function closeVoiceMode() {
            isVoiceMode = false;
            stopRecording();
            stopSpeaking();
            document.getElementById('voiceOverlay').classList.remove('active');
        }

        function toggleVoiceRecording() {
            if (isSpeaking) {
                stopSpeaking();
                return;
            }

            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        async function processVoiceInput(text) {
            if (!text.trim()) return;

            stopRecording();
            
            const status = document.getElementById('voiceStatus');
            const visualizer = document.getElementById('voiceVisualizer');
            if (status) status.innerHTML = '<span>ÏÉùÍ∞ÅÌïòÍ≥† ÏûàÏñ¥Ïöî...</span>';
            if (visualizer) visualizer.classList.remove('listening');
            
            addMessage(text, 'user', true);
            conversationHistory.push({ role: 'user', content: text });

            try {
                const response = await callClaudeAPI(text);
                addMessage(response, 'ai');
                conversationHistory.push({ role: 'assistant', content: response });
                saveMyMateData(response);
                
                if (isVoiceMode) {
                    speak(response);
                }
            } catch (error) {
                const emoji = currentMate === 'prep' ? 'üíú' : 'üíö';
                const errorMsg = `Ï£ÑÏÜ°Ìï¥Ïöî, Ïû†Ïãú Ïó∞Í≤∞Ïù¥ Î∂àÏïàÏ†ïÌïòÎÑ§Ïöî. ${emoji}`;
                addMessage(errorMsg, 'ai');
                
                if (isVoiceMode) {
                    speak(errorMsg);
                }
            }
        }

        // ==================== NAVIGATION ====================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function selectMate(mateType) {
            currentMate = mateType;
            currentStep = 0;
            onboardingData = {};
            
            const mate = mateConfig[mateType];
            const screen = document.getElementById('onboardingScreen');
            
            screen.classList.toggle('purple-theme', mate.isPurple);
            renderStep();
            showScreen('onboardingScreen');
        }

        function goBack() {
            if (currentStep > 0) {
                currentStep--;
                renderStep();
            } else {
                showScreen('homeScreen');
            }
        }

        function goToHome() {
            saveMyMateData();
            closeVoiceMode();
            showScreen('homeScreen');
            updateMyMateSection();
        }

        // ==================== ONBOARDING ====================
        function renderStep() {
            const mate = mateConfig[currentMate];
            if (!mate || !mate.steps || !mate.steps[currentStep]) {
                console.error('renderStep: invalid mate or step', currentMate, currentStep);
                return;
            }
            const step = mate.steps[currentStep];
            const totalSteps = mate.steps.length;
            
            document.getElementById('onboardingAvatar').textContent = mate.emoji;
            document.getElementById('onboardingAvatar').className = `onboarding-avatar ${mate.avatarClass}`;
            document.getElementById('onboardingStep').textContent = `${currentStep + 1}/${totalSteps}`;
            document.getElementById('onboardingTitle').innerHTML = step.title.replace(/\n/g, '<br>');
            document.getElementById('onboardingSubtitle').textContent = step.subtitle || '';
            
            const btn = document.getElementById('onboardingNextBtn');
            btn.textContent = currentStep === totalSteps - 1 ? 'ÎåÄÌôî ÏãúÏûëÌïòÍ∏∞' : 'Îã§Ïùå';
            btn.className = mate.isPurple ? 'btn-primary purple' : 'btn-primary';
            
            const form = document.getElementById('onboardingForm');
            
            if (step.type === 'text') {
                form.innerHTML = `
                    <div class="form-group">
                        <input type="text" class="text-input" id="stepInput" placeholder="${step.placeholder}" value="${onboardingData[step.key] || ''}" maxlength="10">
                        <p class="input-hint">${step.hint || ''}</p>
                    </div>
                `;
                const input = document.getElementById('stepInput');
                input.focus();
                input.addEventListener('input', () => { onboardingData[step.key] = input.value.trim(); updateNextButton(); });
                input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.isComposing) nextStep(); });
            } else if (step.type === 'number') {
                form.innerHTML = `
                    <div class="form-group">
                        <div class="number-input-wrap">
                            <input type="number" class="number-input" id="stepInput" min="${step.min}" max="${step.max}" value="${onboardingData[step.key] || ''}" placeholder="00">
                            <span class="number-suffix">${step.suffix}</span>
                        </div>
                    </div>
                `;
                const input = document.getElementById('stepInput');
                input.focus();
                input.addEventListener('input', () => { onboardingData[step.key] = input.value; updateNextButton(); });
                input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.isComposing) nextStep(); });
            } else if (step.type === 'select') {
                const purpleClass = mate.isPurple ? ' purple' : '';
                form.innerHTML = `
                    <div class="options-list">
                        ${step.options.map(opt => `
                            <button class="option-btn${onboardingData[step.key] === opt.value ? ' selected' + purpleClass : ''}" onclick="selectOption('${step.key}', '${opt.value}', this)">
                                <span class="option-icon">${opt.icon}</span>
                                <span class="option-text">${opt.label}</span>
                                <span class="option-check">‚úì</span>
                            </button>
                        `).join('')}
                    </div>
                `;
            }
            updateNextButton();
        }

        function selectOption(key, value, btn) {
            onboardingData[key] = value;
            
            // ÏÑ†ÌÉù ÌëúÏãúÎßå ÏóÖÎç∞Ïù¥Ìä∏ (Ï†ÑÏ≤¥ Î¶¨Î†åÎçîÎßÅ ÌïòÏßÄ ÏïäÏùå)
            document.querySelectorAll('.option-btn').forEach(b => {
                b.classList.remove('selected', 'purple');
            });
            btn.classList.add('selected');
            
            const mate = mateConfig[currentMate];
            if (mate.isPurple) {
                btn.classList.add('purple');
            }
            
            // Ï≤¥ÌÅ¨ ÏïÑÏù¥ÏΩò ÏóÖÎç∞Ïù¥Ìä∏
            btn.querySelector('.option-check').style.borderColor = mate.isPurple ? 'var(--purple)' : 'var(--olive)';
            btn.querySelector('.option-check').style.background = mate.isPurple ? 'var(--purple)' : 'var(--olive)';
            btn.querySelector('.option-check').style.color = 'white';
            
            // 0.3Ï¥à ÌõÑ Îã§Ïùå Îã®Í≥Ñ
            setTimeout(() => {
                nextStep();
            }, 300);
        }

        function updateNextButton() {
            const mate = mateConfig[currentMate];
            if (!mate || !mate.steps || !mate.steps[currentStep]) return;
            const step = mate.steps[currentStep];
            const btn = document.getElementById('onboardingNextBtn');
            if (!btn) return;
            
            let isValid = false;
            if (step.type === 'text') {
                isValid = (onboardingData[step.key] || '').length >= 2;
            } else if (step.type === 'number') {
                const val = parseInt(onboardingData[step.key]);
                isValid = val >= step.min && val <= step.max;
            } else if (step.type === 'select') {
                isValid = !!onboardingData[step.key];
            }
            btn.disabled = !isValid;
        }

        function nextStep() {
            const mate = mateConfig[currentMate];
            if (!mate || !mate.steps) return;
            if (currentStep < mate.steps.length - 1) {
                currentStep++;
                renderStep();
            } else {
                startChat();
            }
        }

        // ==================== CHAT ====================
        function startChat() {
            const mate = mateConfig[currentMate];
            if (!mate) {
                console.error('startChat: mate not found for', currentMate);
                return;
            }
            
            const avatarEl = document.getElementById('chatAvatar');
            const nameEl = document.getElementById('chatHeaderName');
            if (avatarEl) {
                avatarEl.textContent = mate.emoji;
                avatarEl.className = `chat-header-avatar ${mate.avatarClass}`;
            }
            if (nameEl) nameEl.textContent = mate.name;
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="chat-date"><span>${getTodayDateStr()}</span></div>
                <div class="typing-indicator" id="typingIndicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            conversationHistory = [];
            currentQuickAction = null; // Quick Action Îß•ÎùΩ Î¶¨ÏÖã
            showScreen('chatScreen');
            
            setTimeout(() => {
                const welcomeMsg = mate.getWelcome(onboardingData);
                addMessage(welcomeMsg, 'ai');
                addProfileLink();
            }, 500);
        }

        function getTodayDateStr() {
            const today = new Date();
            const days = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
            return `${today.getFullYear()}ÎÖÑ ${today.getMonth() + 1}Ïõî ${today.getDate()}Ïùº ${days[today.getDay()]}ÏöîÏùº`;
        }

        function addMessage(text, type, isVoice = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const typingIndicator = document.getElementById('typingIndicator');
            const mate = mateConfig[currentMate];
            const time = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: true });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const voiceIndicator = isVoice ? `
                <div class="message-voice-indicator">
                    <svg viewBox="0 0 24 24"><rect x="3" y="8" width="2" height="8" rx="1"/><rect x="7" y="5" width="2" height="14" rx="1"/><rect x="11" y="3" width="2" height="18" rx="1"/><rect x="15" y="5" width="2" height="14" rx="1"/><rect x="19" y="8" width="2" height="8" rx="1"/></svg>
                    ÏùåÏÑ± Î©îÏãúÏßÄ
                </div>
            ` : '';
            
            if (type === 'ai') {
                messageDiv.innerHTML = `
                    <div class="message-avatar ${mate.avatarClass}">${mate.emoji}</div>
                    <div class="message-content">
                        <div class="message-name">${mate.name}</div>
                        <div class="message-bubble">${escapeHtml(text)}</div>
                        <div class="message-time">${time}</div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="message-bubble">${escapeHtml(text)}</div>
                        ${voiceIndicator}
                        <div class="message-time">${time}</div>
                    </div>
                `;
            }
            
            messagesContainer.insertBefore(messageDiv, typingIndicator);
            scrollToBottom();
            
            // ÎåÄÌôî ÌûàÏä§ÌÜ†Î¶¨ Ï†ÄÏû•
            saveChatHistory(text, type);
        }

        function addProfileLink() {
            // ÌîÑÎ°úÌïÑ Í∏∞Îä• ÏóÜÏùå - ÎπÑÌôúÏÑ±Ìôî
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            const container = document.getElementById('chatMessages');
            setTimeout(() => { container.scrollTop = container.scrollHeight; }, 100);
        }

        function showTyping() {
            document.getElementById('typingIndicator').classList.add('show');
            scrollToBottom();
        }

        function hideTyping() {
            document.getElementById('typingIndicator').classList.remove('show');
        }

        function handleChatButton() {
            const input = document.getElementById('chatInput');
            const hasText = input.value.trim().length > 0;
            
            if (hasText) {
                sendMessage();
            } else {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            }
        }

        async function sendMessage(isVoice = false) {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text || isLoading) return;

            addMessage(text, 'user', isVoice);
            input.value = '';
            autoResizeInput();

            conversationHistory.push({ role: 'user', content: text });
saveMessage('user', text); // ÏÑúÎ≤ÑÏóê Ï†ÄÏû•            isLoading = true;
            showTyping();
            updateSendButton();

            try {
                const response = await callClaudeAPI(text);
                hideTyping();
                addMessage(response, 'ai');
                saveMessage('assistant', response); // ÏÑúÎ≤ÑÏóê Ï†ÄÏû•                conversationHistory.push({ role: 'assistant', content: response });
                saveMyMateData(response);
            } catch (error) {
                hideTyping();
                const emoji = currentMate === 'prep' ? 'üíú' : 'üíö';
                addMessage(`Ï£ÑÏÜ°Ìï¥Ïöî, Ïû†Ïãú Ïó∞Í≤∞Ïù¥ Î∂àÏïàÏ†ïÌïòÎÑ§Ïöî. ${emoji}`, 'ai');
            }

            isLoading = false;
            updateSendButton();
        }

        async function callClaudeAPI(userMessage) {
            const stagePrompt = systemPrompts[currentMate] || '';
            let contextInfo = `\n\n## ÏÇ¨Ïö©Ïûê: ${onboardingData.nickname}`;
            
            // Quick Action Îß•ÎùΩ Ï∂îÍ∞Ä
            if (currentQuickAction && currentQuickAction.context) {
                contextInfo += `\n\n## ÌòÑÏû¨ ÎåÄÌôî Îß•ÎùΩ:\n${currentQuickAction.context}`;
            }
            
            const fullSystemPrompt = systemPrompts.base + stagePrompt + contextInfo;

            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1024,
                    system: fullSystemPrompt,
                    messages: conversationHistory
                })
            });

            if (!response.ok) throw new Error(`API error: ${response.status}`);
            const data = await response.json();
            return data.content[0].text;
        }

        function autoResizeInput() {
            const input = document.getElementById('chatInput');
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 100) + 'px';
            updateSendButton();
        }

        function updateSendButton() {
            const btn = document.getElementById('chatSendBtn');
            const waveDiv = document.getElementById('chatBtnWave');
            const input = document.getElementById('chatInput');
            const hasText = input.value.trim().length > 0;
            
            if (hasText) {
                btn.classList.add('send-mode');
                btn.classList.remove('recording');
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>';
            } else {
                btn.classList.remove('send-mode');
                btn.innerHTML = `
                    <div class="sound-wave" id="chatBtnWave">
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                    </div>
                `;
            }
        }

        // ==================== SIDE MENU ====================
        function openSideMenu() {
            document.getElementById('sideMenuOverlay').classList.add('active');
            document.getElementById('sideMenu').classList.add('active');
            renderSideMenuContent();
        }

        function closeSideMenu() {
            document.getElementById('sideMenuOverlay').classList.remove('active');
            document.getElementById('sideMenu').classList.remove('active');
        }

        function renderSideMenuContent() {
            const saved = localStorage.getItem('myMateData');
            const container = document.getElementById('sideMenuContent');
            
            if (!saved) return;
            
            const data = JSON.parse(saved);
            const mateType = data.type;
            
            // ÎßòÍ≥ÅÎ≥Ñ Î©îÎâ¥ ÎßÅÌÅ¨ ÏÑ§Ï†ï
            const menuLinks = [
                { icon: 'ü§∞', name: 'ÎßòÍ≥Å ÌÉúÍµê¬∑ÌÉúÎã¥', url: 'https://www.momgyeot.com' },
                { icon: 'üìñ', name: 'ÏÉàÎ°ú Ïì∞Îäî ÌÉúÍµêÏã†Í∏∞', url: 'https://mktaegyo.replit.app' },
                { icon: 'üìö', name: 'Î™®Ïú†ÏàòÏú† Î¶¨ÏñºÍ∞ÄÏù¥Îìú', url: 'https://breastfeedingrealguide-10.replit.app' },
                { icon: 'ü§±', name: 'Ïú°ÏïÑ Ïª¥Ìå®ÎãàÏñ∏', url: 'https://mothersbaby-ai.vercel.app/' },
                { icon: 'üõí', name: 'ÎßàÎçîÏä§Î≤†Ïù¥ÎπÑ ÏáºÌïëÎ™∞', url: 'https://www.mothersbaby.co.kr' }
            ];

            let linksHTML = menuLinks.map(link => `
                <a class="side-menu-item" href="${link.url}" target="_blank" onclick="closeSideMenu()">
                    <div class="item-icon">${link.icon}</div>
                    <div class="item-info">
                        <div class="item-name">${link.name}</div>
                    </div>
                    <span class="item-arrow">‚Ä∫</span>
                </a>
            `).join('');

            // Îã§Î•∏ ÎßòÍ≥Å ÎßåÎÇòÍ∏∞ ÏÑπÏÖò
            const otherMates = Object.entries(mateConfig)
                .filter(([key]) => key !== mateType)
                .map(([key, mate]) => `
                    <a class="side-menu-item" href="#" onclick="switchMate('${key}'); return false;">
                        <div class="item-icon">${mate.emoji}</div>
                        <div class="item-info">
                            <div class="item-name">${mate.name}</div>
                        </div>
                        <span class="item-arrow">‚Ä∫</span>
                    </a>
                `).join('');

            container.innerHTML = `
                <div class="side-menu-section">
                    <div class="side-menu-section-title">ÎßàÎçîÏä§Î≤†Ïù¥ÎπÑ ÏÑúÎπÑÏä§</div>
                    ${linksHTML}
                </div>
                <div class="side-menu-divider"></div>
                <div class="side-menu-section">
                    <div class="side-menu-section-title">Îã§Î•∏ ÎßòÍ≥Å ÎßåÎÇòÍ∏∞</div>
                    ${otherMates}
                </div>
            `;
        }

        function switchMate(mateType) {
            closeSideMenu();
            // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞ÌôîÌïòÍ≥† ÏÉà ÎßòÍ≥Å ÏÑ†ÌÉù
            localStorage.removeItem('myMateData');
            selectMate(mateType);
        }

        // ==================== MY MATE ====================
        function saveMyMateData(lastMessage = null) {
            if (!currentMate || !onboardingData.nickname) return;
            
            const mate = mateConfig[currentMate];
            const data = {
                type: currentMate,
                name: mate.name,
                emoji: mate.emoji,
                avatarClass: mate.avatarClass,
                onboardingData: onboardingData,
                lastMessage: lastMessage || mate.getWelcome(onboardingData),
                date: new Date().toLocaleDateString('ko-KR', { year: '2-digit', month: '2-digit', day: '2-digit' }).replace(/\. /g, '.').slice(0, -1)
            };
            localStorage.setItem('myMateData', JSON.stringify(data));
        }

        // Ïò§ÎäòÏùò ÌïúÎßàÎîî (ÎûúÎç§)
        const dailyTips = [
            "Ïò§Îäò ÌïòÎ£®ÎèÑ Ï∂©Î∂ÑÌûà Ïûò ÌïòÍ≥† ÏûàÏñ¥Ïöî üíö",
            "ÏôÑÎ≤ΩÌïòÏßÄ ÏïäÏïÑÎèÑ Í¥úÏ∞ÆÏïÑÏöî. Í∑∏Í≤å Ïö∞Î¶¨ Î™®ÏäµÏù¥ÏóêÏöî.",
            "Ïû†Íπê Î©àÏ∂∞ÏÑú Ïà® ÌïúÎ≤à ÍπäÍ≤å Ïâ¨Ïñ¥Î≥¥ÏÑ∏Ïöî.",
            "ÎãπÏã†ÏùÄ ÏµúÍ≥†Ïùò ÏóÑÎßàÏòàÏöî. Îäò Í∑∏Îû¨Ïñ¥Ïöî.",
            "Ïò§Îäò ÎÇòÎ•º ÏúÑÌïú 5Î∂Ñ, ÎßåÎì§Ïñ¥Î≥¥Îäî Í±¥ Ïñ¥ÎïåÏöî?",
            "ÌûòÎì§ Îïê ÌûòÎì§Îã§Í≥† ÎßêÌï¥ÎèÑ Í¥úÏ∞ÆÏïÑÏöî.",
            "ÏïÑÏù¥ÏóêÍ≤å ÌïÑÏöîÌïú Í±¥ ÏôÑÎ≤ΩÌïú ÏóÑÎßàÍ∞Ä ÏïÑÎãàÎùº ÌñâÎ≥µÌïú ÏóÑÎßàÏòàÏöî.",
            "ÏßÄÍ∏à Ïù¥ ÏàúÍ∞Ñ, ÎãπÏã†ÏùÄ Ï∂©Î∂ÑÌï¥Ïöî üíö"
        ];

        function getRandomTip() {
            const today = new Date().toDateString();
            const saved = localStorage.getItem('dailyTip');
            if (saved) {
                const data = JSON.parse(saved);
                if (data.date === today) return data.tip;
            }
            const tip = dailyTips[Math.floor(Math.random() * dailyTips.length)];
            localStorage.setItem('dailyTip', JSON.stringify({ date: today, tip }));
            return tip;
        }

        function renderHomeScreen() {
            const container = document.getElementById('homeContent');
            const saved = localStorage.getItem('myMateData');
            
            if (saved) {
                // Ïò®Î≥¥Îî© ÏôÑÎ£å ÌõÑ - Í∞úÏù∏ÌôîÎêú Ìôà
                const data = JSON.parse(saved);
                const mate = mateConfig[data.type];
                const nickname = data.onboardingData?.nickname || 'Îßò';
                
                // Î©îÎâ¥ Î≤ÑÌäº ÌëúÏãú
                const menuBtn = document.getElementById('menuBtn');
                if (menuBtn) {
                    menuBtn.style.display = 'flex';
                }
                
                // ÎåÄÌôî ÌûàÏä§ÌÜ†Î¶¨ ÏÑπÏÖò Î†åÎçîÎßÅ
                const historySection = renderConversationHistory();
                
                container.innerHTML = `
                    <div class="personalized-greeting">
                        <h1>${nickname}, Ïò§Îäò ÌïòÎ£®Îäî Ïñ¥Îñ†ÏÑ∏Ïöî?</h1>
                        <p>Ïñ∏Ï†úÎì† Ïù¥ÏïºÍ∏∞ ÎÇòÎàå Ï§ÄÎπÑÍ∞Ä ÎêòÏñ¥ÏûàÏñ¥Ïöî</p>
                    </div>

                    <div class="main-mate-card" onclick="resumeChat()">
                        <div class="main-mate-header">
                            <div class="main-mate-avatar ${data.avatarClass}">${data.emoji}</div>
                            <div class="main-mate-info">
                                <div class="main-mate-greeting">ÎÇòÏùò ${data.name}</div>
                                <div class="main-mate-name">${data.date}Ïóê ÎåÄÌôîÌï®</div>
                            </div>
                        </div>
                        <div class="main-mate-message">${truncate(data.lastMessage, 60)}</div>
                        <div class="main-mate-action">
                            <button class="main-mate-btn">Ïù¥Ïñ¥ÏÑú ÎåÄÌôîÌïòÍ∏∞</button>
                        </div>
                    </div>

                    ${historySection}

                    <div class="tip-card">
                        <div class="tip-card-header">
                            <span>üíõ</span>
                            <span class="tip-card-label">Ïò§ÎäòÏùò ÌïúÎßàÎîî</span>
                        </div>
                        <div class="tip-card-content">${getRandomTip()}</div>
                    </div>

                    <div class="section">
                        <h2 class="section-title">Î∞îÎ°úÍ∞ÄÍ∏∞</h2>
                        <div class="quick-actions-mini">
                            <button class="quick-action-mini-btn" onclick="quickAction('status')">
                                <span class="icon green">üíö</span>
                                <span>ÎßàÏùå Ï≤¥ÌÅ¨</span>
                            </button>
                            <button class="quick-action-mini-btn" onclick="quickAction('worry')">
                                <span class="icon pink">‚úèÔ∏è</span>
                                <span>Í±±Ï†ï Ï†ïÎ¶¨</span>
                            </button>
                            <button class="quick-action-mini-btn" onclick="quickAction('today')">
                                <span class="icon olive">‚è∞</span>
                                <span>Ïò§Îäò Ìï† Ïùº</span>
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // Ïò®Î≥¥Îî© Ï†Ñ - Í∏∞Î≥∏ Ìôà
                // Î©îÎâ¥ Î≤ÑÌäº Ïà®Í∏∞Í∏∞
                const menuBtn = document.getElementById('menuBtn');
                if (menuBtn) {
                    menuBtn.style.display = 'none';
                }
                
                container.innerHTML = `
                    <div class="home-greeting">
                        <h1 class="home-title">Ïò§Îäò Ïñ¥Îñ§ ÎßàÏùåÏù¥ÏÑ∏Ïöî?<br>Ìï®Íªò ÎÇòÎà†Î≥ºÍπåÏöî</h1>
                    </div>

                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="quickAction('status')">
                            <span class="icon">üíö</span>
                            <span>ÏßÄÍ∏à ÎÇ¥ ÎßàÏùå Ï≤¥ÌÅ¨</span>
                        </button>
                        <button class="quick-action-btn" onclick="quickAction('worry')">
                            <span class="icon">üìù</span>
                            <span>Í±±Ï†ïÎêòÎäî Í≤É Ï†ïÎ¶¨</span>
                        </button>
                        <button class="quick-action-btn" onclick="quickAction('today')">
                            <span class="icon">üéØ</span>
                            <span>Ïò§Îäò Ìï† Ïùº Ï†ïÌïòÍ∏∞</span>
                        </button>
                    </div>

                    <div class="section">
                        <h2 class="section-title">ÎÇòÏùò <span class="highlight">ÎßòÍ≥Å</span></h2>
                        <div class="empty-my-mate">
                            <p>ÏïÑÏßÅ ÎåÄÌôîÌïú ÎßòÍ≥ÅÏù¥ ÏóÜÏñ¥Ïöî.<br>ÏïÑÎûòÏóêÏÑú ÎßòÍ≥ÅÏùÑ ÏÑ†ÌÉùÌï¥Î≥¥ÏÑ∏Ïöî!</p>
                        </div>
                    </div>

                    <div class="section">
                        <h2 class="section-title"><span class="highlight">Ï∂îÏ≤ú</span> ÎßòÍ≥Å</h2>
                        <div class="mate-list">
                            <div class="mate-card">
                                <div class="mate-avatar purple">üíú</div>
                                <div class="mate-card-info">
                                    <div class="mate-card-name">ÏòàÎπÑÎßòÍ≥Å</div>
                                    <div class="mate-card-desc">Í∏∞Îã§Î¶ºÏùò Ïó¨Ï†ïÏùÑ Ìï®ÍªòÌï¥Ïöî.<br>Ïñ¥Îñ§ ÎßàÏùåÏù¥Îì† Í¥úÏ∞ÆÏïÑÏöî.</div>
                                </div>
                                <button class="mate-card-btn" onclick="selectMate('prep')">ÎåÄÌôî</button>
                            </div>

                            <div class="mate-card">
                                <div class="mate-avatar pink">ü§∞</div>
                                <div class="mate-card-info">
                                    <div class="mate-card-name">ÏûÑÏã†ÎßòÍ≥Å <span class="badge">NEW</span></div>
                                    <div class="mate-card-desc">Ïó¥ Îã¨Ïùò Ïó¨Ï†ï,<br>ÏÑ§Î†òÍ≥º Í±±Ï†ïÏùÑ Ìï®Íªò ÎÇòÎà†Ïöî.</div>
                                </div>
                                <button class="mate-card-btn" onclick="selectMate('pregnancy')">ÎåÄÌôî</button>
                            </div>

                            <div class="mate-card">
                                <div class="mate-avatar olive">üë∂</div>
                                <div class="mate-card-info">
                                    <div class="mate-card-name">ÏÉàÏãπÎßòÍ≥Å</div>
                                    <div class="mate-card-desc">Ïú°ÏïÑ Ï¥àÎ≥¥Ïùò ÌïòÎ£®ÌïòÎ£®,<br>Îì†Îì†Ìïú Í≥ÅÏù¥ ÎêòÏñ¥ÎìúÎ¶¥Í≤åÏöî.</div>
                                </div>
                                <button class="mate-card-btn" onclick="selectMate('infant')">ÎåÄÌôî</button>
                            </div>

                            <div class="mate-card">
                                <div class="mate-avatar olive">üßí</div>
                                <div class="mate-card-info">
                                    <div class="mate-card-name">Ïö∞Î¶¨ÎßòÍ≥Å</div>
                                    <div class="mate-card-desc">ÏÑ±Ïû•ÌïòÎäî ÏïÑÏù¥ÏôÄ Ìï®Íªò,<br>Ïú°ÏïÑ Í≥†ÎØºÏùÑ ÎÇòÎà†Ïöî.</div>
                                </div>
                                <button class="mate-card-btn" onclick="selectMate('toddler')">ÎåÄÌôî</button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function renderOtherMates(currentType) {
            const mates = [
                { type: 'prep', emoji: 'üíú', avatarClass: 'purple', name: 'ÏòàÎπÑÎßòÍ≥Å', desc: 'Í∏∞Îã§Î¶ºÏùò Ïó¨Ï†ïÏùÑ Ìï®ÍªòÌï¥Ïöî.' },
                { type: 'pregnancy', emoji: 'ü§∞', avatarClass: 'pink', name: 'ÏûÑÏã†ÎßòÍ≥Å', desc: 'Ïó¥ Îã¨Ïùò ÏÑ§Î†òÍ≥º Í±±Ï†ïÏùÑ ÎÇòÎà†Ïöî.', badge: 'NEW' },
                { type: 'infant', emoji: 'üë∂', avatarClass: 'olive', name: 'ÏÉàÏãπÎßòÍ≥Å', desc: 'Ïú°ÏïÑ Ï¥àÎ≥¥Ïùò Îì†Îì†Ìïú Í≥Å.' },
                { type: 'toddler', emoji: 'üßí', avatarClass: 'olive', name: 'Ïö∞Î¶¨ÎßòÍ≥Å', desc: 'ÏÑ±Ïû•ÌïòÎäî ÏïÑÏù¥ÏôÄ Ìï®Íªò.' }
            ];
            
            return mates
                .filter(m => m.type !== currentType)
                .map(m => `
                    <div class="mate-card">
                        <div class="mate-avatar ${m.avatarClass}">${m.emoji}</div>
                        <div class="mate-card-info">
                            <div class="mate-card-name">${m.name}${m.badge ? ` <span class="badge">${m.badge}</span>` : ''}</div>
                            <div class="mate-card-desc">${m.desc}</div>
                        </div>
                        <button class="mate-card-btn" onclick="selectMate('${m.type}')">ÎåÄÌôî</button>
                    </div>
                `).join('');
        }

        function updateMyMateSection() {
            // Í∏∞Ï°¥ Ìï®ÏàòÎäî renderHomeScreenÏúºÎ°ú ÎåÄÏ≤¥
            renderHomeScreen();
        }

        function truncate(text, length) {
            if (!text) return '';
            if (text.length <= length) return text;
            return text.substring(0, length) + '...';
        }

        function resumeChat() {
            const saved = localStorage.getItem('myMateData');
            if (!saved) return;
            
            const data = JSON.parse(saved);
            currentMate = data.type;
            onboardingData = data.onboardingData;
            
            // Ï†ÄÏû•Îêú ÎåÄÌôî ÌûàÏä§ÌÜ†Î¶¨ ÌôïÏù∏
            const savedHistory = localStorage.getItem('chatHistory_' + currentMate);
            if (savedHistory) {
                restoreChat(JSON.parse(savedHistory));
            } else {
                startChat();
            }
        }
        
        // ÎåÄÌôî Î≥µÏõê Ìï®Ïàò
        function restoreChat(history) {
            const mate = mateConfig[currentMate];
            if (!mate) {
                console.error('restoreChat: mate not found for', currentMate);
                return;
            }
            
            const avatarEl = document.getElementById('chatAvatar');
            const nameEl = document.getElementById('chatHeaderName');
            if (avatarEl) {
                avatarEl.textContent = mate.emoji;
                avatarEl.className = `chat-header-avatar ${mate.avatarClass}`;
            }
            if (nameEl) nameEl.textContent = mate.name;
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="chat-date"><span>${getTodayDateStr()}</span></div>
                <div class="typing-indicator" id="typingIndicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            conversationHistory = [];
            currentQuickAction = null; // Quick Action Îß•ÎùΩ Î¶¨ÏÖã
            showScreen('chatScreen');
            
            // Ï†ÄÏû•Îêú Î©îÏãúÏßÄÎì§ Î≥µÏõê
            history.forEach(msg => {
                addMessageWithoutSave(msg.text, msg.type, msg.time);
                conversationHistory.push({
                    role: msg.type === 'user' ? 'user' : 'assistant',
                    content: msg.text
                });
            });
            
            // Ïä§ÌÅ¨Î°§ Îß® ÏïÑÎûòÎ°ú
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }
        
        // Ï†ÄÏû• ÏóÜÏù¥ Î©îÏãúÏßÄ Ï∂îÍ∞Ä (Î≥µÏõêÏö©)
        function addMessageWithoutSave(text, type, savedTime) {
            const messagesContainer = document.getElementById('chatMessages');
            const typingIndicator = document.getElementById('typingIndicator');
            const mate = mateConfig[currentMate];
            const time = savedTime || new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: true });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            if (type === 'ai') {
                messageDiv.innerHTML = `
                    <div class="message-avatar ${mate.avatarClass}">${mate.emoji}</div>
                    <div class="message-content">
                        <div class="message-name">${mate.name}</div>
                        <div class="message-bubble">${escapeHtml(text)}</div>
                        <div class="message-time">${time}</div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="message-bubble">${escapeHtml(text)}</div>
                        <div class="message-time">${time}</div>
                    </div>
                `;
            }
            
            messagesContainer.insertBefore(messageDiv, typingIndicator);
        }
        
        // ÎåÄÌôî ÌûàÏä§ÌÜ†Î¶¨ Ï†ÄÏû•
        function saveChatHistory(text, type) {
            if (!currentMate) return;
            
            const key = 'chatHistory_' + currentMate;
            let history = [];
            
            try {
                const saved = localStorage.getItem(key);
                if (saved) history = JSON.parse(saved);
            } catch(e) {}
            
            const now = new Date();
            const time = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: true });
            const timestamp = now.toISOString(); // ISO ÌòïÏãù ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ï∂îÍ∞Ä
            
            history.push({ text, type, time, timestamp });
            
            // ÏµúÍ∑º 100Í∞úÎßå Ïú†ÏßÄ (Îçî ÎßéÏù¥ Ï†ÄÏû•)
            if (history.length > 100) {
                history = history.slice(-100);
            }
            
            try {
                localStorage.setItem(key, JSON.stringify(history));
            } catch(e) {
                console.log('Failed to save chat history');
            }
        }
        
        // ==================== ÎåÄÌôî ÌûàÏä§ÌÜ†Î¶¨ Í¥ÄÎ¶¨ Ìï®ÏàòÎì§ ====================
        
        // Î™®Îì† ÎåÄÌôî ÌûàÏä§ÌÜ†Î¶¨ Í∞ÄÏ†∏Ïò§Í∏∞
        function getAllConversations() {
            const conversations = [];
            const mateTypes = ['prep', 'pregnancy', 'infant', 'toddler'];
            
            mateTypes.forEach(mateType => {
                const key = 'chatHistory_' + mateType;
                try {
                    const saved = localStorage.getItem(key);
                    if (saved) {
                        const history = JSON.parse(saved);
                        if (history.length > 0) {
                            // ÎßàÏßÄÎßâ Î©îÏãúÏßÄ Ï†ïÎ≥¥ Ï∂îÏ∂ú
                            const lastMsg = history[history.length - 1];
                            const mate = mateConfig[mateType];
                            
                            conversations.push({
                                mateType,
                                mateName: mate?.name || mateType,
                                emoji: mate?.emoji || 'üíö',
                                avatarClass: mate?.avatarClass || 'olive',
                                lastMessage: lastMsg.text,
                                lastTime: lastMsg.time,
                                timestamp: lastMsg.timestamp || new Date().toISOString(),
                                messageCount: history.length
                            });
                        }
                    }
                } catch(e) {}
            });
            
            // ÏµúÏã† ÏàúÏúºÎ°ú Ï†ïÎ†¨
            conversations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            return conversations;
        }
        
        // ÎÇ†ÏßúÎ≥ÑÎ°ú Í∑∏Î£πÌïë
        function groupConversationsByDate(conversations) {
            const groups = {};
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            conversations.forEach(conv => {
                const convDate = new Date(conv.timestamp);
                convDate.setHours(0, 0, 0, 0);
                
                let dateLabel;
                if (convDate.getTime() === today.getTime()) {
                    dateLabel = 'Ïò§Îäò';
                } else if (convDate.getTime() === yesterday.getTime()) {
                    dateLabel = 'Ïñ¥Ï†ú';
                } else if (convDate >= weekAgo) {
                    dateLabel = `${convDate.getMonth() + 1}Ïõî ${convDate.getDate()}Ïùº`;
                } else {
                    dateLabel = `${convDate.getMonth() + 1}Ïõî ${convDate.getDate()}Ïùº`;
                }
                
                if (!groups[dateLabel]) {
                    groups[dateLabel] = {
                        label: dateLabel,
                        date: convDate,
                        items: []
                    };
                }
                groups[dateLabel].items.push(conv);
            });
            
            // ÎÇ†ÏßúÏàú Ï†ïÎ†¨ (ÏµúÏã† Î®ºÏ†Ä)
            return Object.values(groups).sort((a, b) => b.date - a.date);
        }
        
        // ÏµúÍ∑º 7Ïùº ÎåÄÌôîÎßå ÌïÑÌÑ∞ÎßÅ
        function getRecentConversations(days = 7) {
            const all = getAllConversations();
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - days);
            
            return all.filter(conv => new Date(conv.timestamp) >= cutoff);
        }
        
        // ÎåÄÌôî ÌûàÏä§ÌÜ†Î¶¨ HTML Î†åÎçîÎßÅ
        function renderConversationHistory() {
            const recent = getRecentConversations(7);
            const all = getAllConversations();
            
            if (all.length === 0) {
                return `
                    <div class="chat-history-section">
                        <div class="chat-history-header">
                            <span class="chat-history-title">üí¨ Ïù¥Ï†Ñ ÎåÄÌôî</span>
                        </div>
                        <div class="no-history-message">
                            ÏïÑÏßÅ ÎåÄÌôî Í∏∞Î°ùÏù¥ ÏóÜÏñ¥Ïöî.<br>ÎßòÍ≥ÅÍ≥º ÎåÄÌôîÎ•º ÏãúÏûëÌï¥Î≥¥ÏÑ∏Ïöî!
                        </div>
                    </div>
                `;
            }
            
            const grouped = groupConversationsByDate(recent);
            const olderCount = all.length - recent.length;
            
            let html = `
                <div class="chat-history-section">
                    <div class="chat-history-header">
                        <span class="chat-history-title">üí¨ Ïù¥Ï†Ñ ÎåÄÌôî</span>
                        <span class="chat-history-count">ÏµúÍ∑º 7Ïùº ¬∑ ${recent.length}Í∞ú</span>
                    </div>
            `;
            
            grouped.forEach(group => {
                html += `
                    <div class="date-group">
                        <div class="date-group-header">
                            <span class="date-group-label">${group.label}</span>
                            <span class="date-group-count">${group.items.length}Í∞ú</span>
                            <div class="date-group-line"></div>
                        </div>
                `;
                
                group.items.forEach(conv => {
                    html += `
                        <div class="history-item" onclick="resumeChatWith('${conv.mateType}')">
                            <div class="history-item-avatar ${conv.avatarClass}">${conv.emoji}</div>
                            <div class="history-item-content">
                                <div class="history-item-name">${conv.mateName}</div>
                                <div class="history-item-preview">${truncate(conv.lastMessage, 30)}</div>
                            </div>
                            <div class="history-item-time">${conv.lastTime}</div>
                            <div class="history-item-arrow">‚Ä∫</div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            // Ï†ÑÏ≤¥ Î≥¥Í∏∞ Î≤ÑÌäº (Îçî Ïò§ÎûòÎêú ÎåÄÌôîÍ∞Ä ÏûàÏùÑ Îïå)
            if (olderCount > 0 || all.length > 3) {
                html += `
                    <button class="view-all-btn" onclick="showAllConversations()">
                        üìÇ Ï†ÑÏ≤¥ ÎåÄÌôî Î≥¥Í∏∞ (${all.length}Í∞ú)
                    </button>
                `;
            }
            
            html += `</div>`;
            return html;
        }
        
        // ÌäπÏ†ï ÎßòÍ≥ÅÍ≥º ÎåÄÌôî Ïù¥Ïñ¥Í∞ÄÍ∏∞
        function resumeChatWith(mateType) {
            currentMate = mateType;
            const mate = mateConfig[mateType];
            if (mate) {
                onboardingData = { nickname: 'Îßò' };
                conversationHistory = [];
                showScreen('chat');
                
                const savedHistory = localStorage.getItem('chatHistory_' + mateType);
                if (savedHistory) {
                    restoreChat(JSON.parse(savedHistory));
                }
            }
        }
        
        // Ï†ÑÏ≤¥ ÎåÄÌôî Î≥¥Í∏∞ Î™®Îã¨
        function showAllConversations() {
            const modal = document.getElementById('historyModal');
            const content = document.getElementById('historyModalContent');
            
            const all = getAllConversations();
            const grouped = groupConversationsByDate(all);
            
            let html = '';
            grouped.forEach(group => {
                html += `
                    <div class="date-group">
                        <div class="date-group-header">
                            <span class="date-group-label">${group.label}</span>
                            <span class="date-group-count">${group.items.length}Í∞ú</span>
                            <div class="date-group-line"></div>
                        </div>
                `;
                
                group.items.forEach(conv => {
                    html += `
                        <div class="history-item" onclick="resumeChatWith('${conv.mateType}'); closeHistoryModal();">
                            <div class="history-item-avatar ${conv.avatarClass}">${conv.emoji}</div>
                            <div class="history-item-content">
                                <div class="history-item-name">${conv.mateName}</div>
                                <div class="history-item-preview">${truncate(conv.lastMessage, 30)}</div>
                            </div>
                            <div class="history-item-time">${conv.lastTime}</div>
                            <div class="history-item-arrow">‚Ä∫</div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            content.innerHTML = html;
            modal.classList.add('active');
        }
        
        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('active');
        }

        // Quick Action ÌîÑÎ°¨ÌîÑÌä∏
        const quickActionPrompts = {
            status: {
                mate: 'infant',
                initialMessage: 'Ïò§Îäò Í∏∞Î∂ÑÏù¥ Ïñ¥Îñ†ÏÑ∏Ïöî?\n\n1Ï†ê(ÌûòÎì§Ïñ¥Ïöî)Î∂ÄÌÑ∞ 10Ï†ê(ÏµúÍ≥†ÏòàÏöî)ÍπåÏßÄ,\nÏà´ÏûêÎ°ú ÌëúÌòÑÌï¥Î≥ºÍπåÏöî? üíö\n\nÏà´ÏûêÎßå ÎßêÏîÄÌï¥Ï£ºÏÖîÎèÑ Ï¢ãÍ≥†,\nÍ∑∏ÎÉ• Ìé∏ÌïòÍ≤å Ïù¥ÏïºÍ∏∞Ìï¥Ï£ºÏÖîÎèÑ Ï¢ãÏïÑÏöî.',
                context: 'ÏÇ¨Ïö©ÏûêÍ∞Ä "ÎßàÏùå Ï≤¥ÌÅ¨" Í∏∞Îä•ÏùÑ ÏÇ¨Ïö© Ï§ëÏûÖÎãàÎã§. 1~10Ï†ê ÏÇ¨Ïù¥Ïùò Ïà´ÏûêÎ°ú Ïò§Îäò Í∏∞Î∂ÑÏùÑ ÌëúÌòÑÌïòÎèÑÎ°ù ÏöîÏ≤≠ÌñàÏäµÎãàÎã§. ÏÇ¨Ïö©ÏûêÍ∞Ä Ïà´ÏûêÎßå ÎãµÌïòÎ©¥ Í∑∏Í≤ÉÏùÄ Í∏∞Î∂Ñ Ï†êÏàòÏûÖÎãàÎã§. Ïòà: "7" = 7Ï†ê(ÍΩ§ Ï¢ãÏùå), "3" = 3Ï†ê(ÌûòÎì¶). Ï†êÏàòÏóê Í≥µÍ∞êÌïòÎ©∞ Îî∞ÎúªÌïòÍ≤å Î∞òÏùëÌï¥Ï£ºÏÑ∏Ïöî.'
            },
            worry: {
                mate: 'infant', 
                initialMessage: 'ÏöîÏ¶ò ÎßàÏùåÏóê Í±∏Î¶¨Îäî Í≤å ÏûàÏúºÏã†Í∞ÄÏöî?\n\nÌÅ¨Îì† ÏûëÎì† ÏÉÅÍ¥ÄÏóÜÏñ¥Ïöî.\nÎßêÎ°ú Í∫ºÎÇ¥ÎÜìÏúºÎ©¥ Ï°∞Í∏àÏùÄ Í∞ÄÎ≤ºÏõåÏßÄÍ∏∞ÎèÑ ÌïòÎçîÎùºÍ≥†Ïöî.\n\nÌé∏ÌïòÍ≤å Ïù¥ÏïºÍ∏∞Ìï¥Ï£ºÏÑ∏Ïöî üíö',
                context: 'ÏÇ¨Ïö©ÏûêÍ∞Ä "Í±±Ï†ï Ï†ïÎ¶¨" Í∏∞Îä•ÏùÑ ÏÇ¨Ïö© Ï§ëÏûÖÎãàÎã§. Í±±Ï†ïÍ±∞Î¶¨Î•º ÎßêÌïòÎ©¥ Í≥µÍ∞êÌïòÍ≥†, Ï†ïÎ¶¨ÌïòÎäî Í≤ÉÏùÑ ÎèÑÏôÄÏ£ºÏÑ∏Ïöî. Ìï¥Í≤∞Ï±ÖÏùÑ Í∞ïÏöîÌïòÏßÄ ÎßêÍ≥† Îì§Ïñ¥Ï£ºÎäî Í≤ÉÏóê ÏßëÏ§ëÌïòÏÑ∏Ïöî.'
            },
            today: {
                mate: 'infant',
                initialMessage: 'Ïò§Îäò ÌïòÎ£®, Îî± ÌïòÎÇòÎßå ÌïúÎã§Î©¥\nÎ≠ò ÌïòÍ≥† Ïã∂ÏúºÏÑ∏Ïöî?\n\nÍ±∞Ï∞ΩÌïú Í≤å ÏïÑÎãàÏñ¥ÎèÑ Í¥úÏ∞ÆÏïÑÏöî.\n"Ïª§Ìîº Ìïú Ïûî ÎßàÏãúÍ∏∞"ÎèÑ Ï¢ãÍ≥†,\n"5Î∂Ñ Îàà Î∂ôÏù¥Í∏∞"ÎèÑ Ï¢ãÏïÑÏöî üíö',
                context: 'ÏÇ¨Ïö©ÏûêÍ∞Ä "Ïò§Îäò Ìï† Ïùº Ï†ïÌïòÍ∏∞" Í∏∞Îä•ÏùÑ ÏÇ¨Ïö© Ï§ëÏûÖÎãàÎã§. Ïò§Îäò ÌïòÍ≥† Ïã∂ÏùÄ Í≤É ÌïòÎÇòÎ•º Ï†ïÌïòÎèÑÎ°ù ÎèÑÏôÄÏ£ºÏÑ∏Ïöî. ÏûëÏùÄ Í≤ÉÎèÑ Í¥úÏ∞ÆÎã§Í≥† Í≤©Î†§Ìï¥Ï£ºÏÑ∏Ïöî.'
            }
        };

        function quickAction(type) {
            console.log('üéØ quickAction called:', type);
            
            const action = quickActionPrompts[type];
            if (!action) {
                console.error('No action found for type:', type);
                return;
            }
            
            // Quick Action Îß•ÎùΩ Ï†ÄÏû•
            currentQuickAction = action;
            
            console.log('Action found:', action);
            
            // Í∏∞Î≥∏ mate ÏÑ§Ï†ï (ÏÉàÏãπÎßòÍ≥Å)
            currentMate = action.mate;
            onboardingData = { nickname: 'Îßò' }; // Í∏∞Î≥∏ ÎãâÎÑ§ÏûÑ
            
            // Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ ÏÇ¨Ïö©
            try {
                const saved = localStorage.getItem('myMateData');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.type && mateConfig[data.type]) {
                        currentMate = data.type;
                    }
                    if (data.onboardingData) {
                        onboardingData = data.onboardingData;
                    }
                }
            } catch (e) {
                console.error('Error loading saved data:', e);
            }
            
            console.log('currentMate:', currentMate, 'onboardingData:', onboardingData);
            
            const mate = mateConfig[currentMate];
            if (!mate) {
                console.error('No mate config for:', currentMate);
                return;
            }
            
            const avatarEl = document.getElementById('chatAvatar');
            const nameEl = document.getElementById('chatHeaderName');
            if (avatarEl) {
                avatarEl.textContent = mate.emoji;
                avatarEl.className = `chat-header-avatar ${mate.avatarClass}`;
            }
            if (nameEl) nameEl.textContent = mate.name;
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="chat-date"><span>${getTodayDateStr()}</span></div>
                <div class="typing-indicator" id="typingIndicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            conversationHistory = [];
            showScreen('chatScreen');
            
            // Quick Action Ï†ÑÏö© Î©îÏãúÏßÄ ÌëúÏãú
            setTimeout(() => {
                addMessage(action.initialMessage, 'ai');
            }, 500);
        }

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            renderHomeScreen();
            initSpeechRecognition();
            
            document.getElementById('chatInput').addEventListener('input', autoResizeInput);
            document.getElementById('chatInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('globalInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.isComposing) {
                    const text = e.target.value.trim();
                    if (text) selectMate('infant');
                }
            });
        });
    </script>
</body>
</html>
